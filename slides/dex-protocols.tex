% Choose one to switch between slides and handout
\documentclass[]{beamer}
%\documentclass[handout]{beamer}

% Video Meta Data
\title{Smart Contracts and Decentralized Finance}
\subtitle{Decentralized Exchange Protocols}
\author{Prof. Dr. Fabian Sch√§r}
\institute{University of Basel}

% Config File
\input{../config/config.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\thispagestyle{empty}
\begin{frame}[noframenumbering]
	\titlepage
\end{frame}

%%%
\begin{frame}{Overview}
	\begin{figure}[h!]
		\input{../assets/figures/overview_exchanges.tex}
	\end{figure}
\end{frame}	
%%%


%%	
\begin{frame}{Why DEXs?}

	\textbf{Problems of CEXs:}
		\begin{small}
		\begin{itemize}
			\item A users' funds must be deposited with the exchange
			\item Access is forfeited and trust towards the exchange operator needed.
			\item Singe point of attack $\rightarrow$ Constant threat of becoming target of malicious third parties.
		\end{itemize}
		\end{small}	

\vspace{1.5em}

\uncover<2>{
	\textbf{Advantages of DEXs:}
		\begin{small}
		\begin{itemize}
			\item User remains in exclusive control of assets until trade is executed.
			\item Atomic trade execution = One indivisible transaction.
			\item No counterparty risk.
		\end{itemize}
		\end{small}
}
\end{frame}
%%%

%%%
\begin{frame}{The Emergence of Decentralized Exchanges}
Shapeshift V1:
\begin{itemize}
	\item Quote valid for 15 minutes
	\item Send token A to exchange address
	\item Get back token B immediately
	\item Not really decentralized
	\item Faced regulatory pressure
\end{itemize}
\vspace{0.5cm}

Etherdelta:
\begin{itemize}
	\item Onchain orderbook exchange %offchain orderbook?
	\item During ICO hype
	\item High fees
	\item Hacked
\end{itemize}

Constant Function Market Makers:
\begin{itemize}
	\item Currently highest volume
	\item Uniswap introduced in November 2018
\end{itemize}
\end{frame}
%%%

%%%
\begin{frame}{Constant Function Market Maker}

	\begin{figure}	
		\centering
		\input{../assets/figures/cfmm.tex}
	\end{figure}

\only<4>{
	\begin{itemize}
		\item The price is determined endogenously via a formula.
		\item The trader pays a fee which is added to the liquidity pool. Since no new Pool tokens are minted, this has the effect of splitting the transaction fee proportionally between all Liquidity Providers.
	\end{itemize}
}

\end{frame}
%%%


%%%
\begin{frame}{Arbitrage}
	\begin{figure}
		\begin{tikzpicture}
		
		\end{tikzpicture}
	\end{figure}
	\begin{itemize}
		\item When the pool price differs from the market price (e.g on a centralized exchange), there is an arbitrage opportunity. Therefore, the Pool Price should be the same as the Market Price.
	\end{itemize}	
\end{frame}
%%%


%%%
\begin{frame}{Constant Product Market Maker}
Constant Product Formula:
	\begin{align*}
		x \cdot y &= k
	\end{align*}

	\begin{itemize}
		\item[] x: amount of x-tokens in the pool
		\item[] y: amount of y-tokens in the pool
		\item[] k: constant
	\end{itemize}
	\vspace{1cm}
	\uncover<2->{
		Relative Prices are given by the first derivative of k:
		\vspace{0.2cm}
		\begin{itemize}
			\item[] $P_x = \frac{y}{x}$
			\item[] $P_y = \frac{x}{y}$
		\end{itemize}
	}
\end{frame}
%%%


%%%
\begin{frame}{Constant Product Market Maker}
	\begin{figure}[h!]
		\begin{center}
			\input{../assets/figures/constant_product_function.tex}
		\end{center}
	\end{figure}
\end{frame}
%%%


%%%
\begin{frame}{Constant Product Market Maker}
Constant Product Formula:
	\begin{align*}
		x \cdot y &= k
	\end{align*}
	
	\textbf{Properties:}
	\begin{itemize}
		\item<1-> Convexity of the indifference set
		\item<2-> Dynamic endogenous pricing model
		\item<3-> The pool will never be depleted and always be able to quote relative prices
	\end{itemize}
\end{frame}
%%%

%%%
\begin{frame}{Swap (without fees)}
	Let's assume a constant product market maker with no fees. Suppose an agent wants to exchange $\Delta x$ of x-tokens into y-tokens
	\vspace{0.5cm}
	\begin{figure}[h!]
		\begin{center}
			\input{../assets/figures/swap_without_fees.tex}
		\end{center}
	\end{figure}	
\end{frame}
%%%

%%%
\begin{frame}{Swap (without fees)}
	\begin{figure}[h!]
		\begin{center}
			\input{../assets/figures/constant_product_swap_no_fees.tex}
		\end{center}
	\end{figure}
\end{frame}
%%%


%%%
\begin{frame}{Swap (without fees)}
	\vspace{0.5cm}
		\begin{align*}
			\onslide<1->{ y' &= \biggl( \frac{k}{x + \Delta x} \biggr) }\\
			\onslide<2->{ \Delta y &= y - \biggl( \frac{k}{x + \Delta x} \biggr) }\\
			\onslide<3->{ k' &= (x + \Delta x) \cdot (y - \Delta y) = k }
		\end{align*}	
\end{frame}
%%%


%%%
\begin{frame}{Swap (with fees)}
	Let us now assume a fee $\rho \in [0,1)$ with $\gamma = 1 - \rho$. The fee is charged on every trade and added to the liquidity pool and therefore leads to an increase in $k$. 
\end{frame}
%%%


%%%
\begin{frame}{Swap (with fees)}
	\begin{figure}[h!]
		\begin{center}
			\input{../assets/figures/constant_product_swap_with_fees.tex}
		\end{center}
	\end{figure}
\end{frame}
%%%

%%%
\begin{frame}{Swap (with fees)}
	\vspace{0.5cm}
		\begin{align*}
			\onslide<1->{ y'_\rho &= \biggl( \frac{k}{x + \gamma \cdot \Delta x} \biggr) }\\
			\onslide<2->{ \Delta y_\rho &= y - \biggl( \frac{k}{x + \gamma \cdot \Delta x} \biggr) }\\
			\onslide<3->{ k'_\rho &= (x + \Delta x) \cdot (y - \Delta y_\rho) > k }
		\end{align*}	
\end{frame}
%%%


%%%
\begin{frame}{Liquidity Provision}
Anyone can contribute liquidity to the pool, by providing $n$ $x$-tokens and $n \cdot \frac{y}{x}$ $y$-tokens to the smart contract.\\
	
	\begin{itemize}
		\item<2-> The liquidity provision only changes the token amounts and the constant $k$
		\item<3-> The ratio between the two tokens remains unchanged
		\item<4-> Both reserves are increased by the factor $\varphi = \frac{\Delta(x)}{x} = \frac{\Delta(y)}{y}$
	\end{itemize}

	\begin{align*}
		\onslide<5->{ x' &= x +\Delta x = (1+\varphi) x }\\
		\onslide<6->{ y' &= y +\Delta y = (1+\varphi) y}\\
		\onslide<7->{ k' &= (1+\varphi)^2 k	}
	\end{align*}
\end{frame}
%%%


%%%
\begin{frame}{Liquidity Provision}
	\begin{figure}[h!]
		\begin{center}
			\input{../assets/figures/constant_product_liquidity_provision.tex}
		\end{center}
	\end{figure}
\end{frame}
%%%


%%%
\begin{frame}{Divergence Loss}

	\textbf{General assumptions:} No fees, no other LPs \\ 
		\begin{enumerate}
			\item We provide 10 units both of ETH and CIF, which are equal in value ($1 \tfrac{CIF}{ETH}$).
			\begin{align*}
				10 \cdot 10 = 100	
			\end{align*}
			\item The price for ETH on the open market doubles, the price of CIF stays the same ($2 \tfrac{CIF}{ETH}$). After arbitrage, the pool balances should adjust to:
			\begin{align*}
				y &= \sqrt{k/P_{y}}	 = \sqrt{100/2} = 7.0716 \\
				x &= k / y = 100 / 7.0716 = 14.141
			\end{align*}
		\end{enumerate}	
\end{frame}
%%%


%%%
\begin{frame}{Divergence Loss}

	\begin{enumerate}
	\setcounter{enumi}{2}
		\item The total pool value, expressed in units of Token A is: 
			\begin{align*}
				7.0716 \cdot 2 \tfrac{CIF}{ETH} + 14.141 \cdot 1 \tfrac{CIF}{ETH} = 28.284 CIF
			\end{align*}
		\item If we simply held our initial allocation, we would have:
			\begin{align*}
			10 \cdot 2 \tfrac{CIF}{ETH} + 10 \cdot 1 \tfrac{CIF}{ETH} = 	30 CIF
			\end{align*}
		\item The difference between the Pool Value and the Hold Value is called divergence loss.
		\begin{align*}
			DL = \tfrac{Pool_V}{Hold_V} -1 = \tfrac{28.284}{30} - 1 = -5.72 \%
			\end{align*}
	\end{enumerate}	
	
	\begin{keytakeaway}{Note}
		In order to be profitable, a LP must collect more fees than the Divergence Loss. DL is only realized by selling the LP position (burning LP Tokens). There is no DL if the price ratio between the two pool assets stays equal.
	\end{keytakeaway}
	
\end{frame}
%%%


%%%
\begin{frame}{Swap one x-token with 0.03\% fee}
	%\textbf{Swap one x-token with a fee of 0.3 \%} \\ \vspace{1.5em}

	\begin{minipage}{0.5\textwidth}
		\begin{figure}[h!]
			\begin{center}
 				\input{../assets/figures/swap_example.tex}
			\end{center}
		\end{figure}
	\end{minipage}
\vspace{1em}
	\begin{minipage}{0.4\textwidth}
		\vspace{-4em}
		\begin{scriptsize}
			\begin{align*}
			\only<1>{
				\Delta y &= \dfrac{k}{x+ (1-\tau) \Delta x} - y \\
			}
			\only<2>{
			 	\Delta y &= \tfrac{100}{10+ (1-0.003) \cdot 10} - 10 = -0.9066 \\
		 		y' &= 10 - 0.9066 = 9.0934 \\
		 		k' &= 11 \cdot 9.0934 = 100.0274 \\
		 	}
		 	\only<3>{
		 		y' &= 10 - 0.9066 = 9.0934 \\
		 		k' &= 11 \cdot 9.0934 = 100.0274 \\
			}
			\only<4>{
				P &= \tfrac{y}{x} = \tfrac{10}{10} = 1 \\
				P_{swap} &= \tfrac{\Delta y}{\Delta x} = \tfrac{0.9066}{1} = 0.9066\\
				P' &= \tfrac{y'}{x'} = \tfrac{9.0934}{11} =  0.8267 \\
			}
			\only<5>{
				S &= \tfrac{Swap Price}{PR} - 1 = \tfrac{0.9066}{1} - 1 = -0.0934 \\
			}
			\end{align*}
		\end{scriptsize}
	\end{minipage}

\end{frame}
%%%


%%%
\begin{frame}{Swap one x-token in a bigger pool}
	%\textbf{Swap one x-token with a fee of 0.3 \%} \\

	\begin{minipage}{0.5\textwidth}
		\begin{figure}[h!]
			\begin{center}
				\input{../assets/figures/swap_example_2.tex}
			\end{center}
		\end{figure}
	\end{minipage}
\vspace{1em}
	\begin{minipage}{0.4\textwidth}
		\vspace{-4em}
		\begin{scriptsize}
			\begin{align*}
			\only<1>{
				PR &= \tfrac{y}{x} = \tfrac{100}{100} = 1 \\
				P_{swap} &= \tfrac{\Delta y}{\Delta x} = \tfrac{0.9872}{1} = 0.9872\\
				PR' &= \tfrac{y'}{x'} = \tfrac{99.0128}{101} =  0.9803 \\
			}
			\only<2>{
				S &= \tfrac{P_{swap}}{P} - 1 = \tfrac{0.9872}{1} - 1 = -0.0128 \\
			}
			\end{align*}
		\end{scriptsize}
	\end{minipage}
	
	\uncover<2>{
	\begin{keytakeaway}{Impact of Pool/Trade Ratio}
	In our first example, the trader got 0.9066 y-Tokens, in the second 0.9872. When the trade size is smaller compared to the total pool liquidity, slippage is also reduced. In our example from $\approx$ 10\% to $\approx$ 1.3\%.
	\end{keytakeaway}

	}
		
\end{frame}
%%%



%%%
\begin{frame}{Other Bonding Curves}
	\begin{figure}
		\includegraphics[scale=0.6]{../assets/images/bonding-curves.png}
	\end{figure}
\end{frame}
%%%


%%%
\begin{frame}{Concentrated Liquidity}
	Concept of concentrated liquidity was first introduced in Uniswap V3 in March 2021\footnote{\href{https://uniswap.org/whitepaper-v3.pdf}{Uniswap V3 Whitepaper \link}}:
	\begin{itemize}
		\item<2-> Liquidity providers can add liquidity within a certain price range $[p_a, p_b]$.
		\item<3-> The position is active, if the price is within the given range.
		\item<4-> If the price is out of range, the liquidity provider only holds one asset and does not collect fees.
	\end{itemize}
	\vspace{0.5cm}
	\uncover<5->{
	\begin{keytakeaway}{Implications of Concentrated Liquidity}
		\begin{itemize}
			\item<5-> Higher capital efficiency
			\item<6-> Liquidity providers with concentrated liquidity earn more fees
			\item<7-> But: higher divergence loss risk
		\end{itemize}
	\end{keytakeaway}

	}
\end{frame}
%%%


%%%
\begin{frame}{Concentrated Liquidity}
	\begin{figure}[h!]
		\begin{center}
			\input{../assets/figures/concentrated_liquidity.tex}
		\end{center}
	\end{figure}	
\end{frame}
%%%


%%%
\begin{frame}{More than two Pool Assets}
\begin{itemize}
	\item The constant of UniSwap can also be extended to pools with more than two assets.
	\item Constant Mean Formula:
		\begin{align*}
			V = \prod_t B^{w_{t}}_{t}
		\end{align*}
	V : constant, w : normalized weight $[0,1]$, B : Balance
	\item The Constant Product formula is basically just a subset of the Constant Mean formula with two equally weighted assets ($w_t$ = 0.5).
\end{itemize}

\end{frame}
%%%


%%%
\begin{frame}{Concept of Aggregators}

\begin{figure}[t]
	\centering	
	\resizebox{0.8\textwidth}{!}{
	\begin{tikzpicture}[scale=1.0, every node/.style={scale=1.0}]
			\input{../assets/figures/defi_stack.tex}
	\end{tikzpicture}}
	\caption{The DeFi Stack \cite{FS:21}}
\end{figure}
\vspace{-1em}
\begin{itemize}
	\item DEX Aggregators source liquidity from different DEXs
	\item They allow a user to compare different swap prices and to choose on which DEX their trade is performed.
\end{itemize}


%DEX aggregators source liquidity from different DEXs and thus offer users better token swap rates than they could get on any single DEX. DEX aggregators have the ability to optimize slippage, swap fees and token prices which, when done right, offer a better rate for users.
\end{frame}
%%%


%%%
\begin{frame}{Frontrunning}

\end{frame}
%%%


%%%
\begin{frame}{Add. Liquidity Mining \& Vampire Attack}

\end{frame}
%%%


%%%
\begin{frame}{Initial DEX offerings}

\end{frame}
%%%


%%%
\begin{frame}{Exercise}
	\begin{exercise}{Exercise 1}
	For this exercise we use the ERC20 Token created in one of the previous videos (select Ropsten). Go to UniSwap Frontend Link to complete the following tasks:
	
		\begin{enumerate}
			\item Swap ETH to CIF
			\item Provide liquidity to ETH/CIF Pool
			\item Make another Swap
			\item Remove your liquidity position and analyze what happened
		\end{enumerate}
	\end{exercise}
\end{frame}
%%%



%%%
\begin{frame}%[allowframebreaks]
\frametitle{References and Recommended Reading}
	% Uniswap Whitepaper
	% Curve Whitepaper
	\bibliographystyle{amsplain}
	\bibliography{../assets/bib/refs}
\end{frame}
%%%





\end{document}