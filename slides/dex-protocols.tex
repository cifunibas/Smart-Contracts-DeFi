% Choose one to switch between slides and handout
\documentclass[]{beamer}
%\documentclass[handout]{beamer}

% Video Meta Data
\title{Smart Contracts and Decentralized Finance}
\subtitle{Decentralized Exchange Protocols}
\author{Prof. Dr. Fabian Sch√§r}
\institute{University of Basel}

% Config File
\input{../config/config.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\thispagestyle{empty}
\begin{frame}[noframenumbering]
	\titlepage
\end{frame}


%%%
\begin{frame}{Exchanges}

	\begin{figure}[h!]
		\begin{tikzpicture}
		[ sibling distance =10em ,
		every node/.style = {shape=rectangle, rounded corners,
		draw , align = center,
		%top color=white, bottom color = highlight
		}]]
 		\tikzstyle{level 1}=[sibling distance=30mm]
 		\tikzstyle{level 2}=[sibling distance=20mm]
 		\tikzstyle{level 3}=[sibling distance=18mm]
  
  			\node {Exchange Protocols}
  			child { node [red] {centralized}}
  			child { node {decentralized}
  				child { node {\scriptsize{Order Book}}
  					child { node {\scriptsize{on-Chain}}}
  					child { node {\scriptsize{off-Chain}}}}
  				child { node {\scriptsize{OTC/ P2P}}}
  				child { node[right=-8mm] {\scriptsize{Reserve Aggregator}}}
  				child { node[right=1em] {\scriptsize{Const. Function}\\ \scriptsize{Market Maker}}}
  			};
		\end{tikzpicture}
	\end{figure}

	\begin{keytakeaway}{Problems}
		To be able to trade on a CEX, a users' funds must be deposited with the exchange. Thereby, access is forfeited and trust towards the exchange operator needed.  CEXs are also a single point of attack and face the constant threat of becoming the target of malicious third parties.
	\end{keytakeaway}
	
\end{frame}
%%%


%%%
\begin{frame}{Decentralized Exchange Protocols}



\end{frame}
%%%


%%%
\begin{frame}{Constant Function Market Maker}

\begin{figure}	
\centering
	\begin{tikzpicture}
	
	% Pool
	\draw [thick] (-1,-1.5) -- (1,-1.5);
	\draw [thick](-1,-1.5) -- (-1, 0.6);
	\draw [thick](1,-1.5) -- (1, 0.6);
	\node [below=0.8cm] at (0,-0.8) {\scriptsize{Liquidity Pool}};
	
	% Balanced Pool
\uncover<2,3>{	
	\draw [fill=highlight] (-1,-1.5) rectangle (-0,0.25);
	\draw [fill=strongmint] (0,-1.5) rectangle (1,0.25);
}	

	% Unbalanced Pool
\uncover<4,5>{
	\draw [fill=highlight] (-1,-1.5) rectangle (-0,0);
	\draw [fill=strongmint] (0,-1.5) rectangle (1,0.5);
	\draw [dashed] (-1,0.25) -- (1,0.25);
}	

	% Token labels
\uncover<2->{
\node at (-0.5,-0.7) {\scriptsize{CIF}};
\node at (0.5,-0.7) {\scriptsize{ETH}};
}

\uncover<4->{
 \node at (-4.5, 0.5) {\scriptsize{Pool Token}};
}
	
	%% LPs, Trader
	\uncover<1->{
		\node at (-4.5,-0.5) {\includegraphics[scale=0.03]{../assets/images/agents/agent_right}};
		\node at (-4,-0.8) {\includegraphics[scale=0.03]{../assets/images/agents/agent_right}};
		\node at (-5,-0.8) {\includegraphics[scale=0.03]{../assets/images/agents/agent_right}};
		\node [below=0.8cm] at (-4.5,-0.8) {\scriptsize{Liquidity Providers}};
		}
	\uncover<1->{
		\node at (4,-0.8) {\includegraphics[scale=0.05]{../assets/images/agents/agent_left}};
		\node [below=0.8cm]at (4,-0.8) {\scriptsize{Trader}};
		}
		
	%% Flow
	\uncover<2>{
		\draw[->] (-3.5, -0.8) -- (-1.5, -0.8) node [midway, below] {\includegraphics[scale=0.004]{../assets/images/eth}};
		\draw[->] (-3.5, -0.5) -- (-1.5, -0.5) node [midway, above]{\scriptsize{CIF}};
	}
	\uncover<3>{
	\draw[->] (-1.5, -0.8) -- (-3.5, -0.8) node [midway, above] {\scriptsize{Pool Token}};
	}
	\uncover<4>{
		\draw[->] (3.5, -0.8) -- (1.2, -0.8) node [midway, above] {\includegraphics[scale=0.004]{../assets/images/eth}};
		}
%	\uncover<5>{
%		\draw[->] (1.5, -0.5) -- (3.5, -0.5) node [midway, above] {\includegraphics[scale=0.05]{../assets/images/dai}};
%		}
		
	\uncover<4>{
		\draw[->] (-0.5,0) arc (150:30:2.5cm) node [midway, above] {\scriptsize{CIF}};
	
		\draw[dashed, <-] (-3.5,-2.5) arc (-130:-50:5.5cm) node [midway, above] {\scriptsize{Fees}};
	}
	
	\uncover<5>{
	\draw (0,1) node {\scriptsize{Arbitrage Opportunity}};
	}
		
	\end{tikzpicture}
	
\end{figure}


%\begin{enumerate}
%	\item<2-> Liquidity Providers (LPs) provide both tokens in equal value.
%	\item<3-> LPs get a Pool Token that represents their share.
%	\item<4-> Traders trade against the Liquidity Pool.
%	\item<5-> Price is determined endogenously via a formula.
%	\item<6-> Arbitrage opportunities keep price up to date.
%	\item<6-> Each trade accrues fees that go to LPs.
%\end{enumerate}


\end{frame}
%%%


%%%
\begin{frame}{Constant Product Formula}
	\only<1-4>{
		\begin{align*}
			k &= x \cdot y
		\end{align*}
	}
	\only<1>{
		\begin{itemize}
			\item k: constant
			\item x: number of x-tokens in the pool
			\item y: number of y-tokens in the pool
		\end{itemize}
		\vspace{0.5cm}
	}

	\only<2-4>{\textbf{Properties:}}
	\begin{itemize}
		\item<3-4> Convexity of the indifference set
		\item<4> Dynamic endogenous pricing model
	\end{itemize}
	
	\only<5>{
		\begin{figure}[h!]
			\begin{center}
				\input{../assets/figures/constant_product_function.tex}
			\end{center}
		\end{figure}
	}
\end{frame}
%%%

%%%
\begin{frame}{AMM Functions}
	\begin{itemize}
		\item<1-> swap():
		\item<2-> mint():
		\item<3-> burn(): 
	\end{itemize}
\end{frame}
%%%

%%%
\begin{frame}{Swap (without fees)}
	\only<1>{
		\begin{figure}[h!]
			\begin{center}
				\input{../assets/figures/constant_product_swap_no_fees.tex}
			\end{center}
		\end{figure}
	}

	\only<2>{
		\begin{align*}
			k &= (x + \Delta x) \cdot (y - \Delta y) \\
			\Delta y &= y - \biggl( \frac{k}{x + \Delta x} \biggr)
		\end{align*}
		
		\begin{itemize}
			\item TODO: Explain slippage and relation to trade size / pool size
		\end{itemize}
	}

\end{frame}
%%%


%%%
\begin{frame}{Swap (with fees)}
	\input{../assets/figures/constant_product_swap_with_fees.tex}
\end{frame}
%%%


%%%
\begin{frame}{Liquidity Provision}

\end{frame}
%%%


%%%
\begin{frame}{Divergence Loss}

\end{frame}
%%%


%%%
\begin{frame}{Swap Example}

\textbf{Swap one x-token with a fee of 0.3 \%} \\

	\begin{minipage}{0.5\textwidth}

		\begin{figure}[h!]
		\begin{center}
 		\begin{tikzpicture}[]
	
			% function
      		\draw[samples = 200, color=blue, scale=1, xshift = 0cm, yshift = 0cm, domain=0.9:4.55, smooth, variable=\x] plot ({\x}, {4/\x}) node[right,color=blue] {\scriptsize{$k = 100$}} ;
      
     		\uncover<2->{ 
      		\draw[samples = 200, color=blue, scale=1, xshift = 0cm, yshift = 0cm, domain=1.345:4.55, smooth, variable=\x] plot ({\x}, {6/\x}) node[right,color=blue] {\scriptsize{$k_\rho = 100.0273$}} ; 
 			}
 			
			% x-axis
  			\draw[->] (0,0)--(5,0) node[below,midway]{} node[right] {$x$-tokens} ;
  			% y-axis
  			\draw[->] (0,0)--(0,5) node[above,midway,rotate=90]{} node[above] {$y$-tokens};
  	
  			% first state
  			\uncover<1->{
    		\draw[dotted, thick] (2,2)--(0,2) node[left]{\scriptsize{10}};
    
   			\draw[dotted, thick] (2,2)--(2,0) node[below]{\scriptsize{10}};
    	
  			\draw[fill=black] (2,2) circle(2pt);
   			}
    
    		%second state
    		\uncover<2->{
    
    		% reserves after swap (incl. fees)
			\draw[fill=black] (3.5,1.715) circle(2pt);
			\draw[dotted,thick] (3.5,1.715) -- (3.5,0) node[below]{\scriptsize{11}};
			\draw[dotted,thick] (3.5,1.715) -- (0,1.715) node[left]{\scriptsize{9.0934}};
	
			% reserves after swap (excl. fees)
			\draw[dotted,thick] (3.5,1.13) -- (0,1.13) node[left]{\scriptsize{9.0909}};
    		}
    
    		\end{tikzpicture}
			\end{center}
			%\caption{Visualization of the token reserve adjustments during an exchange, considering the constant product constraint.}
			%\label{fig:constantproductconstraint}
			\end{figure}

	\end{minipage}
\vspace{1em}
	\begin{minipage}{0.4\textwidth}
	\vspace{-4em}
	\begin{scriptsize}
	\begin{align*}
		\Delta (y) &= \dfrac{k}{x+ (1-f) \Delta (x)} - y \\
		\uncover<2>{
		\Delta (y) &= \dfrac{100}{10+ (1-0.003) \cdot 10} - 10 \\
		\Delta (y) &= -0.9066
		}
	\end{align*}
	\end{scriptsize}
	\end{minipage}

\end{frame}
%%%


%%%
\begin{frame}{Different Functions (Curve)}

\end{frame}
%%%


%%%
\begin{frame}{Concentrated Liquidity}

\end{frame}
%%%


%%%
\begin{frame}{n $>$ 2 Pool Assets}

\end{frame}
%%%


%%%
\begin{frame}{Concept of Aggregators}

\end{frame}
%%%


%%%
\begin{frame}{Frontrunning}

\end{frame}
%%%


%%%
\begin{frame}{Add. Liquidity Mining \& Vampire Attack}

\end{frame}
%%%


%%%
\begin{frame}{Initial DEX offerings}

\end{frame}
%%%


%%%
\begin{frame}{Exercise}
	\begin{exercise}{Exercise 1}
	For this exercise we use the ERC20 Token created in one of the previous videos (select Ropsten). Go two UniSwap Frontend Link to complete the following tasks:
	
		\begin{enumerate}
			\item Swap ETH to CIF
			\item Provide liquidity to ETH/CIF Pool
			\item Make another Swap
			\item Remove your liquidity position and analyze what happened
		\end{enumerate}
	\end{exercise}
\end{frame}
%%%



%%%
\begin{frame}%[allowframebreaks]
\frametitle{References and Recommended Reading}
	\bibliographystyle{amsplain}
	\bibliography{../assets/bib/refs}
\end{frame}
%%%





\end{document}