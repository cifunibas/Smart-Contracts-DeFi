% Choose one to switch between slides and handout
\documentclass[]{beamer}
%\documentclass[handout]{beamer}

% Video Meta Data
\title{Smart Contracts and Decentralized Finance}
\subtitle{Decentralized Exchange Protocols}
\author{Prof. Dr. Fabian Sch√§r}
\institute{University of Basel}

% Config File
\input{../config/config.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\thispagestyle{empty}
\begin{frame}[noframenumbering]
	\titlepage
\end{frame}


%%%
\begin{frame}{Exchange Overview}

	\begin{figure}[h!]
		\input{../assets/figures/overview_exchanges.tex}
	\end{figure}
	
\only<2>{
\textbf{Problems of CEXs:}
\begin{small}
\begin{itemize}
	\item A users' funds must be deposited with the exchange
	\item Access is forfeited and trust towards the exchange operator needed.
	\item Singe point of attack $\rightarrow$ Constant threat of becoming target of malicious third parties.
\end{itemize}
\end{small}
}	

\only<3>{
\textbf{Advantages of DEXs:}
\begin{small}
\begin{itemize}
	\item User remains in exclusive control of assets until trade is executed.
	\item Atomic trade execution = One indivisible transaction.
	\item No counterparty risk.
\end{itemize}
\end{small}
}
\end{frame}
%%%


%%%
\begin{frame}{Decentralized Exchange Protocols}

\end{frame}
%%%


%%%
\begin{frame}{Constant Function Market Maker}

	\begin{figure}	
		\centering
		\input{../assets/figures/cfmm.tex}
	\end{figure}

\only<4>{
	\begin{itemize}
		\item The price is determined endogenously via a formula.
		\item The trader pays a fee which is added to the liquidity pool. Since no new Pool tokens are minted, this has the effect of splitting the transaction fee proportionally between all Liquidity Providers.
		%\item When the pool price differs from the market price (e.g on a centralized exchange), there is an arbitrage opportunity. %This keeps the price up to date (in line with Market Price).
	\end{itemize}
}

\only<5>{
	\begin{itemize}
		\item When the pool price differs from the market price (e.g on a centralized exchange), there is an arbitrage opportunity. This should keep the price in line with the Market Price.
	\end{itemize}
}

\end{frame}
%%%


%%%
\begin{frame}{Constant Product Formula}
	\only<1-4>{
		\begin{align*}
			k &= x \cdot y
		\end{align*}
	}
	\only<1>{
		\begin{itemize}
			\item k: constant
			\item x: number of x-tokens in the pool
			\item y: number of y-tokens in the pool
		\end{itemize}
		\vspace{0.5cm}
	}

	\only<2-4>{\textbf{Properties:}}
	\begin{itemize}
		\item<3-4> Convexity of the indifference set
		\item<4> Dynamic endogenous pricing model
	\end{itemize}
	
	\only<5>{
		\begin{figure}[h!]
			\begin{center}
				\input{../assets/figures/constant_product_function.tex}
			\end{center}
		\end{figure}
	}
\end{frame}
%%%

%%%
\begin{frame}{AMM Functions}
	\begin{itemize}
		\item<1-> swap():
		\item<2-> mint():
		\item<3-> burn(): 
	\end{itemize}
\end{frame}
%%%

%%%
\begin{frame}{Swap (without fees)}
	\only<1>{
		\begin{figure}[h!]
			\begin{center}
				\input{../assets/figures/constant_product_swap_no_fees.tex}
			\end{center}
		\end{figure}
	}

	\only<2>{
		\begin{align*}
			k &= (x + \Delta x) \cdot (y - \Delta y) \\
			\Delta y &= y - \biggl( \frac{k}{x + \Delta x} \biggr)
		\end{align*}
		
		\begin{itemize}
			\item TODO: Explain slippage and relation to trade size / pool size
		\end{itemize}
	}

\end{frame}
%%%


%%%
\begin{frame}{Swap (with fees)}
	\input{../assets/figures/constant_product_swap_with_fees.tex}
\end{frame}
%%%


%%%
\begin{frame}{Liquidity Provision}

\end{frame}
%%%


%%%
\begin{frame}{Divergence Loss}
		\textbf{General assumptions:} No fees, no other LPs \\ 
		
		\begin{enumerate}
			\item We provide 10 units both of ETH and CIF, both valued at 1\$.
			\begin{align*}
			10 \cdot 1\$ + 10 \cdot 1\$ = 20 \$	
			\end{align*}
			\item The price for ETH on the open market doubles to 2\$, the price of CIF stays the same. This opens up an arbitrage opportunity in the pool. After arbitrage, prices should correspond  to the market prices and with the following pool balances.
			\begin{align*}
			x &= \sqrt{k/P_{x}}	 = \sqrt{100/2} = 7.0716 \\
			y &= k / x = 100 / 7.0716 = 14.141
			\end{align*}
		\end{enumerate}
		
\end{frame}
%%%


%%%
\begin{frame}{Swap one x-token with 0.03\% fee}

%\textbf{Swap one x-token with a fee of 0.3 \%} \\ \vspace{1.5em}

	\begin{minipage}{0.5\textwidth}
		\begin{figure}[h!]
			\begin{center}
 				\input{../assets/figures/swap_example.tex}
			\end{center}
		\end{figure}
	\end{minipage}
\vspace{1em}
	\begin{minipage}{0.4\textwidth}
		\vspace{-4em}
		\begin{scriptsize}
			\begin{align*}
			\only<1>{
				\Delta (y) &= \dfrac{k}{x+ (1-\tau) \Delta (x)} - y \\
			}
			\only<2>{
			 	\Delta (y) &= \dfrac{100}{10+ (1-0.003) \cdot 10} - 10 \\
		 		&= -0.9066 \\
		 	}
		 	\only<3>{
		 		y' &= 10 - 0.9066 = 9.0934 \\
		 		k' &= 11 \cdot 9.0934 = 100.0274 \\
			}
			\only<4>{
				PR &= \dfrac{y}{x} = 10/10 = 1 \\
				P_{eff} &= \dfrac{\Delta (y)}{\Delta (x)} = \dfrac{0.9066}{1} = 0.9066\\
				PR' &= \dfrac{y'}{x'} = \dfrac{9.0934}{11} =  0.8267 \\
			}
			\only<5>{
				S &= \dfrac{P_{eff}}{PR} - 1 = \dfrac{0.9066}{1} - 1 = -0.0934 \\
			}
			\end{align*}
		\end{scriptsize}
	\end{minipage}

\end{frame}
%%%


%%%
\begin{frame}{Swap one x-token in a bigger pool}
	%\textbf{Swap one x-token with a fee of 0.3 \%} \\

	\begin{minipage}{0.5\textwidth}
		\begin{figure}[h!]
			\begin{center}
				\input{../assets/figures/swap_example_2.tex}
			\end{center}
		\end{figure}
	\end{minipage}
\vspace{1em}
	\begin{minipage}{0.4\textwidth}
		\vspace{-4em}
		\begin{scriptsize}
			\begin{align*}
			\only<1>{
				PR &= \dfrac{y}{x} = 100/100 = 1 \\
				P_{eff} &= \dfrac{\Delta (y)}{\Delta (x)} = \dfrac{0.9872}{1} = 0.9872\\
				PR' &= \dfrac{y'}{x'} = \dfrac{99.0128}{101} =  0.9803 \\
			}
			\only<2>{
				S &= \dfrac{P_{eff}}{PR} - 1 = \dfrac{0.9872}{1} - 1 = -0.0128 \\
			}
			\end{align*}
		\end{scriptsize}
	\end{minipage}
	
	\uncover<2>{
	\begin{keytakeaway}{Slippage}
	In our first example, the trader got 0.9066 y-Tokens, in the second 0.9872. When the trade size is smaller compared to the total pool liquidity, slippage is also reduced. In our example from $\approx$ 10\% to $\approx$ 1.3\%.
	\end{keytakeaway}

	}
		
\end{frame}
%%%




%%%
\begin{frame}
	\begin{enumerate}
	\setcounter{enumi}{2}
		\item The total pool value now is: 
			\begin{align*}
			7.0716 \cdot 2 \$ + 14.141 \cdot 1 \$ = 	28.284 \$
			\end{align*}
		\item If we simply held our initial allocation, we would have:
			\begin{align*}
			10 \cdot 2 \$ + 10 \cdot 1 \$ = 	30 \$
			\end{align*}
		\item The difference between the Pool Value and the Hold Value is called divergence loss.
		\begin{align*}
			DL = \tfrac{Pool_V}{Hold_V} -1 = \tfrac{28.284}{30} - 1 = -5.72 \%
			\end{align*}
	\end{enumerate}	
\begin{keytakeaway}{Note}
	In order to be profitable, a LP must collect more fees than the Divergence Loss. DL is only realized by selling the LP position (burning LP Tokens). There is no DL if the price ratio between the two pool assets stays equal.
\end{keytakeaway}

\end{frame}
%%%


%%%
\begin{frame}{Different Bonding Curves}
\begin{figure*}
	\includegraphics[scale=0.6]{../assets/images/bonding-curves.png}
\end{figure*}
%\begin{tikzpicture}[]
%    
%    \draw[samples = 200, color=blue, scale=1, xshift = 0cm, yshift = 0cm, domain=0.9:4.55, smooth, variable=\x] plot ({\x}, {4/\x}) node[right,color=blue] {\scriptsize{Uniswap}} ;
%   	\draw[samples = 200, color=red, scale=1, xshift = 0cm, yshift = 0cm, domain=0.9:4.55, smooth, variable=\x] plot ({\x}, {4-\x})
%    	node[right,color=red] {\scriptsize{linear function}} ;    
%    
%  	\draw[->] (0,0)--(5,0) node[below,midway]{} node[right] {$x$-tokens} ;
%    \draw[->] (0,0)--(0,5) node[above,midway,rotate=90]{} node[above] {$y$-tokens};  
%  
%    \draw[dotted, thick] (2,2)--(0,2) node[left]{\scriptsize $y$};
%
%    \draw[dotted, thick] (2,2)--(2,0) node[below, yshift = -0.08cm]{\scriptsize $x$};
%  
%	\draw[fill=black] (2,2) circle(2pt);
%
%%% https://miguelmota.com/blog/understanding-stableswap-curve/
%
%\end{tikzpicture}
\end{frame}
%%%


%%%
\begin{frame}{Concentrated Liquidity}

\end{frame}
%%%


%%%
\begin{frame}{n $>$ 2 Pool Assets}

\end{frame}
%%%


%%%
\begin{frame}{Concept of Aggregators}

\end{frame}
%%%


%%%
\begin{frame}{Frontrunning}

\end{frame}
%%%


%%%
\begin{frame}{Add. Liquidity Mining \& Vampire Attack}

\end{frame}
%%%


%%%
\begin{frame}{Initial DEX offerings}

\end{frame}
%%%


%%%
\begin{frame}{Exercise}
	\begin{exercise}{Exercise 1}
	For this exercise we use the ERC20 Token created in one of the previous videos (select Ropsten). Go two UniSwap Frontend Link to complete the following tasks:
	
		\begin{enumerate}
			\item Swap ETH to CIF
			\item Provide liquidity to ETH/CIF Pool
			\item Make another Swap
			\item Remove your liquidity position and analyze what happened
		\end{enumerate}
	\end{exercise}
\end{frame}
%%%



%%%
\begin{frame}%[allowframebreaks]
\frametitle{References and Recommended Reading}
	\bibliographystyle{amsplain}
	\bibliography{../assets/bib/refs}
\end{frame}
%%%





\end{document}