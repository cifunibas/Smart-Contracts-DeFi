% Choose one to switch between slides and handout
\documentclass[]{beamer}
%\documentclass[handout]{beamer}

% Video Meta Data
\title{Smart Contracts and Decentralized Finance}
\subtitle{Decentralized Exchange Protocols}
\author{Prof. Dr. Fabian Schär}
\institute{University of Basel}

% Config File
\input{../config/config.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\thispagestyle{empty}
\begin{frame}[noframenumbering]
	\titlepage
\end{frame}


%%%	
\begin{frame}{Why Decentralized Exchanges?}

	\textbf{Problems of centralized exchanges (CEX):}
		\begin{small}
		\begin{itemize}
			\item A user's funds must be deposited with the exchange
			\item Access is forfeited and trust towards the exchange operator needed.
			\item Singe point of attack $\rightarrow$ Constant threat of becoming target of malicious third parties.
		\end{itemize}
		\end{small}	

\vspace{1.5em}

\uncover<2>{
	\textbf{Advantages of decentralized exchanges (DEX):}
		\begin{small}
		\begin{itemize}
			\item User remains in exclusive control of assets until trade is executed.
			\item Atomic trade execution = One indivisible transaction.
			\item No counterparty risk.
		\end{itemize}
		\end{small}
}
\end{frame}
%%%

%%%
\begin{frame}{Overview}
	\begin{figure}[h!]
		% TODO: cite FED paper
		\input{../assets/figures/overview_exchanges.tex}
	\end{figure}
\end{frame}	
%%%


%%%
\begin{frame}{Constant Function Market Maker}

	\begin{figure}	
		\centering
		\input{../assets/figures/cfmm.tex}
	\end{figure}

	\begin{itemize}
		\item<5-> {The price is determined endogenously via a function.}
		\item<6-> The trader pays a fee which is added to the liquidity pool. Since no new pool tokens are minted, this has the effect of splitting the transaction fee proportionally between all liquidity providers. % TODO: neu formulieren
	\end{itemize}


\end{frame}
%%%


%%%
\begin{frame}{Arbitrage}
	\begin{figure}
		\begin{tikzpicture}
		
		\end{tikzpicture}
	\end{figure}
	\begin{itemize}
		\item If the pool price differs from the market price (e.g., on other exchanges), there is an arbitrage opportunity. This opportunity is expected to keep the pool price close to the market price.
	\end{itemize}	
\end{frame}
%%%


%%%
\begin{frame}{Constant Product Market Maker}
Constant Product Function:
	\begin{align*}
		x \cdot y &= k
	\end{align*}

	\begin{itemize}
		\item[] x: amount of X-tokens in the pool
		\item[] y: amount of Y-tokens in the pool
		\item[] k: constant
	\end{itemize}
	\vspace{1cm}
	\uncover<2->{
		Relative Prices are given by the first derivative of k:
		\vspace{0.2cm}
		\begin{itemize}
			\item[] $P_x = \frac{y}{x}$
			\item[] $P_y = \frac{x}{y}$
		\end{itemize}
	}
\end{frame}
%%%


%%%
\begin{frame}{Constant Product Market Maker}
	\begin{figure}[h!]
		\begin{center}
			\input{../assets/figures/constant_product_function.tex}
		\end{center}
	\end{figure}
\end{frame}
%%%


%%%
\begin{frame}{Constant Product Market Maker}
Constant Product Function:
	\begin{align*}
		x \cdot y &= k
	\end{align*}
	
	\textbf{Properties:}
	\begin{itemize}
		\item<1-> Convexity of the indifference set
		\item<2-> Dynamic endogenous pricing model
		\item<3-> The pool will never be depleted by a trade and always be able to quote relative prices
	\end{itemize}
\end{frame}
%%%

%%%
\begin{frame}{Swap (without fees)}
	Let us assume a constant product market maker with no fees. Suppose a trader wants to exchange $\Delta x$ of X-tokens into Y-tokens
	\vspace{0.5cm}
	\begin{figure}[h!]
		\begin{center}
			\input{../assets/figures/swap_without_fees.tex}
		\end{center}
	\end{figure}	
\end{frame}
%%%

%%%
\begin{frame}{Swap (without fees)}
	\begin{figure}[h!]
		\begin{center}
			\input{../assets/figures/constant_product_swap_no_fees.tex}
		\end{center}
	\end{figure}
\end{frame}
%%%


%%%
\begin{frame}{Swap (without fees)}
		\begin{align*}
			\onslide<1->{
				\intertext{	Token Y pool reserves after trade: }
				y' &= \frac{k}{x + \Delta x}\\
			}
			\vspace{0.5cm}
			\onslide<2->{ 
				\intertext{ Change in token Y reserve: }
				\Delta y &= y -\frac{k}{x + \Delta x}\\  
			}
			\vspace{0.5cm}
			\onslide<3->{
				\intertext{ Constant $k$ after trade: }				
				k' &= (x + \Delta x) \cdot (y - \Delta y) = k
			}
		\end{align*}	
\end{frame}
%%%


%%%
\begin{frame}{Swap (with fees)}
	Let us now assume a fee $\rho \in [0,1)$ with $\gamma = 1 - \rho$. The fee is charged on every trade and added to the liquidity pool and therefore leads to an increase in $k$. 
\end{frame}
%%%


%%%
\begin{frame}{Swap (with fees)}
	% TODO replace k' with k'_\rho
	\begin{figure}[h!]
		\begin{center}
			\input{../assets/figures/constant_product_swap_with_fees.tex}
		\end{center}
	\end{figure}
\end{frame}
%%%


%%%
\begin{frame}{Swap (with fees)}
	\begin{align*}
		\onslide<1->{
			\intertext{	Token Y pool reserves after trade: }
			y'_\rho &= \frac{k}{x + \gamma \cdot \Delta x}\\
		}
		\vspace{0.5cm}
		\onslide<2->{ 
			\intertext{ Change in token Y reserve: }
			\Delta y_\rho &= y - \frac{k}{x + \gamma \cdot \Delta x}\\  
		}
		\vspace{0.5cm}
		\onslide<3->{
			\intertext{ Constant $k$ after trade: }				
			k'_\rho &= (x + \Delta x) \cdot (y - \Delta y_\rho) \ge k
		}
	\end{align*}	

\end{frame}
%%%


%%%
\begin{frame}{Swap one x-token with 0.03\% fee}
	%\textbf{Swap one x-token with a fee of 0.3 \%} \\ \vspace{1.5em}

	\begin{minipage}{0.5\textwidth}
		\begin{figure}[h!]
			\begin{center}
 				\input{../assets/figures/swap_example.tex}
			\end{center}
		\end{figure}
	\end{minipage}
\vspace{1em}
	\begin{minipage}{0.4\textwidth}
		\vspace{-4em}
		\begin{scriptsize}
			\begin{align*}
			\only<1>{
				\Delta y_{\rho} &= y - \dfrac{k}{x+ \gamma \cdot \Delta x} \\
			}
			\only<2>{
			 	\Delta y_{\rho} &= 10 - \tfrac{100}{10+ (1-0.003) \cdot 10} = 0.9066 \\
		 		y'_{\rho} &= 10 - 0.9066 = 9.0934 \\
		 		k'_{\rho} &= 11 \cdot 9.0934 = 100.0274 \\
		 	}
		 	\only<3>{
		 		y'_{\rho} &= 10 - 0.9066 = 9.0934 \\
		 		k'_{\rho} &= 11 \cdot 9.0934 = 100.0274 \\
			}
			\only<4>{
				P_{x} &= \tfrac{y}{x} = \tfrac{10}{10} = 1 \\
				P_{x, swap} &= \tfrac{\Delta y}{\Delta x} = \tfrac{0.9066}{1} = 0.9066\\
				P'_{x} &= \tfrac{y'}{x'} = \tfrac{9.0934}{11} =  0.8267 \\
			}
			\only<5>{
				S &= \tfrac{P_{x, swap}}{P_x} - 1 = \tfrac{0.9066}{1} - 1 = -0.0934 \\
			}
			\end{align*}
		\end{scriptsize}
	\end{minipage}

\only<5>{Slippage $S$ is the deviation from the price for an infinitesimal trade $P_x$ to the price for an actual trade $P_{x,swap}$.}
\end{frame}
%%%


%%%
\begin{frame}{Swap one X-token in a Bigger pool}
	%\textbf{Swap one x-token with a fee of 0.3 \%} \\

	\begin{minipage}{0.5\textwidth}
		\begin{figure}[h!]
			\begin{center}
				\input{../assets/figures/swap_example_2.tex}
			\end{center}
		\end{figure}
	\end{minipage}
\vspace{1em}
	\begin{minipage}{0.4\textwidth}
		\vspace{-4em}
		\begin{scriptsize}
			\begin{align*}
			\only<1>{
				P_x &= \tfrac{y}{x} = \tfrac{100}{100} = 1 \\
				P_{x,swap} &= \tfrac{\Delta y}{\Delta x} = \tfrac{0.9872}{1} = 0.9872\\
				P'_x &= \tfrac{y'}{x'} = \tfrac{99.0128}{101} =  0.9803 \\
			}
			\only<2>{
				S &= \tfrac{P_{x,swap}}{P_x} - 1 = \tfrac{0.9872}{1} - 1 = -0.0128 \\
			}
			\end{align*}
		\end{scriptsize}
	\end{minipage}
	
	\uncover<2>{
	\begin{keytakeaway}{Impact of Pool Size}
	In our first example, the trader got 0.9066 y-Tokens, in the second 0.9872. When the trade size is smaller compared to the total pool liquidity, slippage is also reduced. In our example from $\approx$ 9.3\% to $\approx$ 1.3\%.
	\end{keytakeaway}

	}
		
\end{frame}
%%%



%%%
\begin{frame}{Liquidity Provision}
Anyone can contribute liquidity to the pool, by providing $n$ $X$-tokens and $n \cdot \frac{y}{x}$ $Y$-tokens to the smart contract.\\
	
	\begin{itemize}
		\item<2-> The liquidity provision only changes the token amounts and the constant $k$
		\item<3-> The ratio between the two tokens remains unchanged
		\item<4-> Both reserves are increased by the factor $\varphi = \frac{\Delta(x)}{x} = \frac{\Delta(y)}{y}$
	\end{itemize}

	\begin{align*}
		\onslide<5->{ x' &= x +\Delta x = (1+\varphi) x }\\
		\onslide<6->{ y' &= y +\Delta y = (1+\varphi) y}\\
		\onslide<7->{ k' &= (1+\varphi)^2 k	}
	\end{align*}
\end{frame}
%%%


%%%
\begin{frame}{Liquidity Provision}
	\begin{figure}[h!]
		\begin{center}
			\input{../assets/figures/constant_product_liquidity_provision.tex}
		\end{center}
	\end{figure}
\end{frame}
%%%


%%%
\begin{frame}{Divergence Loss}

	\textbf{General assumptions:} No fees, no other LPs \\ 
		\begin{enumerate}
			\item We provide 10 units of Token X and Token Y, which are equal in value ($P_x = \tfrac{Y}{X} = 1$).
				\begin{align*}
					k &= x \cdot y = 10 \cdot 10 = 100	
				\end{align*}
			\item Now lets assume the price of X doubles ($P'_x = 2$). Therefore, the pool balances adjust to:
				\begin{align*}
					x' &= \sqrt{k/P'_{x}}	 = \sqrt{100/2} = 7.0716\\
					y' &= k / x' = 100 / 7.0716 = 14.141
				\end{align*}
			\item The total pool value, expressed in units of Token Y is: 
				\begin{align*}
					V_{pool} &= x' \cdot P_x + y' = 2 \cdot y'\\
					V_{pool} &= 2 \cdot 14.141 = 28.1762
				\end{align*}
		\end{enumerate}	
\end{frame}
%%%


%%%
\begin{frame}{Divergence Loss}

	\begin{enumerate}
	\setcounter{enumi}{3}
		\item If we simply held our initial allocation, we would have:
			\begin{align*}
				V_{hold} &= x \cdot P'_x + y\\
				V_{hold} &= 10 \cdot 2 + 10 = 30
			\end{align*}
		\item The difference between the pool value and the hold value is called divergence loss:
			\begin{align*}
				DL &= \tfrac{V_{pool}}{V_{hold}} - 1\\
				DL &= \tfrac{28.284}{30} - 1 = -5.72 \%
			\end{align*}
	\end{enumerate}	
	
	\begin{keytakeaway}{Note}
		\begin{itemize}
			\item In order to be profitable, a LP must collect more fees than the Divergence Loss.
			\item DL is only realized by closing the LP position. There is no DL if the price ratio between the two pool assets stays equal or returns to the initial ratio.
		\end{itemize}
	\end{keytakeaway}
	
\end{frame}
%%%

% TODO: Divergence Loss graph



%%%
\begin{frame}{Other Bonding Curves}

\begin{small}
\begin{itemize}
	\item The concept of CFMMs can be extended to other functionss, with different attributions and trade-offs. 
	\item The stableswap invariant, introduced by Curve\footnote{\href{https://curve.fi/files/stableswap-paper.pdf}{Curve Whitepaper \link}}, is useful for swapping tokens which are pegged to the same underlying asset, e.g. stablecoins.
	\end{itemize}
\end{small}

	\begin{figure}
		\includegraphics[scale=0.6]{../assets/images/bonding-curves.png}
	\end{figure}
	
\end{frame}
%%%


%%%
\begin{frame}{Concentrated Liquidity}
	Concept of concentrated liquidity was first introduced in Uniswap V3 in March 2021\footnote{\href{https://uniswap.org/whitepaper-v3.pdf}{Uniswap V3 Whitepaper \link}}:
	\begin{itemize}
		\item<2-> Liquidity providers can add liquidity within a certain price range $[p_a, p_b]$.
		\item<3-> The position is active, if the price is within the given range. % 
		\item<4-> If the price is out of range, the liquidity provider only holds one asset and does not collect fees.
	\end{itemize}
	\vspace{0.5cm}
	\uncover<5->{
	\begin{keytakeaway}{Implications of Concentrated Liquidity}
		\begin{itemize}
			\item<5-> Higher capital efficiency
			\item<6-> Liquidity providers with concentrated liquidity earn more fees
			\item<7-> But: higher divergence loss risk
		\end{itemize}
	\end{keytakeaway}

	}
\end{frame}
%%%


%%%
\begin{frame}{Concentrated Liquidity}
	% Update graphs (different color for concentrated position)
	\begin{figure}[h!]
		\begin{center}
			\input{../assets/figures/concentrated_liquidity.tex}
		\end{center}
		\only<1>{\caption*{Liquidity provision on full price range\footnote{\href{https://uniswap.org/whitepaper-v3.pdf}{Uniswap V3 Whitepaper \link}}}}
		\only<2>{\caption*{Concentrated liquidity position on range $[P_a, P_b]$\footnote{\href{https://uniswap.org/whitepaper-v3.pdf}{Uniswap V3 Whitepaper \link}}}}
		\only<3>{\caption*{Aggregated liquidity positions\footnote{\href{https://uniswap.org/whitepaper-v3.pdf}{Uniswap V3 Whitepaper \link}}}}
	\end{figure}	
\end{frame}
%%%


%%%
\begin{frame}{More Than two Pool Assets}

The constant product function as implemented by Uniswap can be extended to pools with more than two assets:
		\begin{align*}
			\prod_{i=1}^N x_i= k
		\end{align*}
		
$N$: number of tokens in the pool\\
$x_i$: token amount for asset i\\
$k$: constant

\end{frame}
%%%


%%%
\begin{frame}{Constant Mean Function}
\begin{itemize}
	\item The constant product function can be further extended by using different weights (constant mean function)\footnote{\href{https://balancer.fi/whitepaper.pdf}{Balancer Whitepaper \link}}:
		\begin{align*}
			\prod_{i=1}^N x_i^{w_i}= k
		\end{align*}

		$N$: number of tokens in the pool\\
		$x_i$: token amount for asset i\\
		$w_i$: weight of asset $i$\\
		$k$: constant
		\vspace{0.5cm}
	\item The constant product function is basically just a subset of the constant mean function with equally weighted assets ($w_i = 1$).
\end{itemize}

\end{frame}
%%%


%%%
\begin{frame}{Concept of Aggregators}
% TODO: Aggregator einfärben analog vorherigem Slidedeck
\begin{figure}
	\centering
	\resizebox{0.8\textwidth}{!}{
	\begin{tikzpicture}[scale=1.0, every node/.style={scale=1.0}]
			\input{../assets/figures/defi_stack.tex}
	\end{tikzpicture}}
\end{figure}
	
\begin{itemize}
	\item DEX Aggregators source liquidity from different DEXs.
	\item They allow a user to compare different swap prices and to choose on which DEX their trade is performed.
\end{itemize}

\end{frame}
%%%


%%%
\begin{frame}{Frontrunning}
	% Left: actions
	% right: curve
\end{frame}
%%%


%%%
\begin{frame}{Liquidity Mining \& Vampire Attack}
	\begin{figure}[h!]
		\begin{center}
			\input{../assets/figures/vampire_attack.tex}
		\end{center}
	\end{figure}
\end{frame}
%%%


%%%
\begin{frame}{Initial DEX offerings}

\end{frame}
%%%


%%%
\begin{frame}{Exercise}
	\begin{exercise}{Exercise 1}
	% Create new token and corresponding Uniswap pool	
			%For this exercise we use the ERC20 Token created in one of the previous videos. Go to \href{https://app.uniswap.org/#/swap}{Uniswap \link} to complete the following tasks:
		\begin{enumerate}
			\item Make sure you are connected to the Ropsten testnet
			\item List your token on Uniswap
			\item Trade your own token
		\end{enumerate}
	\end{exercise}
	
	\begin{exercise}{Exercise 2}
	% Create new token and corresponding Uniswap pool	
			%For this exercise we use the ERC20 Token created in one of the previous videos. Go to \href{https://app.uniswap.org/#/swap}{Uniswap \link} to complete the following tasks:
		\begin{enumerate}
			\item Make sure you are connected to the Ropsten testnet
			\item Swap ETH to CIF
			\item Provide liquidity to the ETH/CIF Pool
			\item Make another Swap
			\item Remove your liquidity position and analyze what happened
		\end{enumerate}
	\end{exercise}
\end{frame}
%%%



%%%
\begin{frame}%[allowframebreaks]
\frametitle{References and Recommended Reading}

		\bibliographystyle{amsplain}
		\bibliography{../assets/bib/refs}
	% Uniswap Whitepaper
	% Vitalik Blogpost AMM https://www.reddit.com/r/ethereum/comments/55m04x/lets_run_onchain_decentralized_exchanges_the_way/
	% Uniswap V2/V3 Whitepaper
	% Curve Whitepaper
	% Balancer Whitepaper
	% DeFi Overview
	
\end{frame}
%%%





\end{document}