% Choose one to switch between slides and handout
\documentclass[]{beamer}
%\documentclass[handout]{beamer}

% Video Meta Data
\title{Smart Contracts and Decentralized Finance Applications}
\subtitle{Gas and Fees}
\author{Prof. Dr. Fabian Schär}
\institute{University of Basel}

% Config File
\input{../config/config.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\thispagestyle{empty}
\begin{frame}[noframenumbering]
	\titlepage
\end{frame}

%%%	
\begin{frame}{The Halting Problem and its Implications}
\begin{columns}
	\begin{column}{0.3\textwidth}
		\center
		\includegraphics[width=\textwidth , frame]{../assets/images/alan-turing.png}
	\end{column}
	\begin{column}{0.7\textwidth}
		In 1936, Alan Turing proved that it's impossible for a (turing) machine to inspect any code that you give it, and correctly tell you whether the code will halt or run forever.\\
		\vspace{1em}
		\link \href{https://www.cs.virginia.edu/~robins/Turing_Paper_1936.pdf}{Online PDF}\\
		\vspace{1em}	
		\uncover<2->{Implication: Infinite loops or resource intensive scripts are a potential attack vector and must be dealt with.}\\
	\end{column}
\end{columns}
\uncover<3->{
	\begin{keytakeaway}{Bitcoin and Ethereum Deal With This Problem in Different Ways}
		\begin{itemize}
			\item Bitcoin Script is a restricted scripting language.
			\item Ethereum has a Turing complete instruction set. It charges a small fee (gas) for each computation step.
		\end{itemize}
	\end{keytakeaway}
}
\end{frame}
%%%

%%%
%% TODO: Flexible block size limit erklären --> evtl. separates slide für EIP-1559 related changes
\begin{frame}{Ethereum Gas Fees: The Basics}
	\begin{itemize}
		\item Every EVM operation consumes a pre-defined amount of gas. These values cannot be changed by user. Some examples\footnote{\href{https://docs.google.com/spreadsheets/d/1m89CVujrQe5LAFJ8-YAUCcNK950dUzMQPMJBxRtGCqs}{Full list} \link}:
			\begin{columns}
				\uncover<2->{
				\begin{column}{0.08\textwidth} %% TODO: is there a better way?
				\end{column}
				\begin{column}{0.25\textwidth}
					\begin{samplecode}{Addition}
						\begin{center}
							\includegraphics[width=2em]{../assets/images/plus.png}
						\end{center}
						$\rightarrow$ 3 gas units 
					\end{samplecode}				
				\end{column}
				}
				\uncover<3->{
				\begin{column}{0.25\textwidth}
					\begin{samplecode}{Multiplication}
						\begin{center}
							\includegraphics[width=2em]{../assets/images/multiply.png}
						\end{center}
						$\rightarrow$ 5 gas units 
					\end{samplecode}
				\end{column}
				}
				\uncover<4->{
				\begin{column}{0.25\textwidth}
					\begin{samplecode}{Store 256 bits}
						\begin{center}
							\includegraphics[width=2em]{../assets/images/database.png}
						\end{center}
						$\rightarrow$ 20k gas units 
					\end{samplecode}	
				\end{column}
				}
				\begin{column}{0.02\textwidth} %% TODO: is there a better way?
				\end{column}
			\end{columns}
		\uncover<5->{
		\item Every transaction has a user-specified \textbf{gas limit}, i.e. the maximum number of gas units that can be in this transaction.
		\hspace{-1em}
		\begin{itemize}
			\item 21000 required to send ETH
			\item Contract execution varies
		\end{itemize}
		}
		\uncover<6->{
		\hspace{1em}
		\item Every transaction has a certain \textbf{gas price}, i.e. the price in $\mu ETH$ or GWEI the user pays per unit of gas.
		}
	\end{itemize} 
\end{frame}
%%%

%%%
\begin{frame}{Ethereum Gas Fees: EIP-1559}
	On August 5, 2021 (at block 12.965.000), an upgrade of the gas mechanism to Ethereum was introduced through the London hard fork\footnote{\href{https://ethereum.org/en/history/\#london}{More details on the London hard fork \link}}. The update is called EIP-1559\footnote{\href{https://eips.ethereum.org/EIPS/eip-1559}{More details on EIP 1559 \link}}.\\
	According to the authors of the proposal, the update addresses the following issues: % Note: Copy paste from eip
	\begin{itemize}
		\item Mismatch between volatility of transaction fee levels and social cost of transactions
		\item Needless delays for users
		\item Inefficiencies of first price auctions
		\item Instability of blockchains with no block reward
	\end{itemize}
\end{frame}
%%%

%%%
\begin{frame}{Ethereum Gas Fees: Gas Price Before EIP-1559}
	\begin{center}
		\begin{tikzpicture}
			\input{../assets/figures/gasPricePre1559.tex}
		\end{tikzpicture}
	\end{center}
	
	\begin{itemize}
		\uncover<1->{
			\item User specifies gas price, he is willing to pay for the transaction	
		}
		\uncover<2->{
			\item Miners are incentivized to include transactions with higher gas prices first
			\item All fees go to miner of the block
		}
	\end{itemize}
\end{frame}
%%%

%%%
\begin{frame}{Ethereum Gas Fees: Gas Price After EIP-1559}
	\begin{center}
		\begin{tikzpicture}
			\input{../assets/figures/gasPricePost1559.tex}
		\end{tikzpicture}
	\end{center}	
\end{frame}
%%%

%%%
\begin{frame}{Ethereum Gas Fees: Gas Price After EIP-1559}
	\begin{itemize}
		\item \textbf{Base fee} is calculated by the network depending on demand for block space. It can in- or decrease by max 12.5\% from one block to the next. It gets burned by the network, taking ETH out of circulation.
		\item \textbf{Priority fee (tip)} is set by the user to give the miner an incentive to include the transaction in the block. Miner receives the priority fee of all included transactions.
		\item \textbf{Max fee (optional)} is set by the user and corresponds to the maximum willingness to pay for one unit of gas. Transaction remains pending if $baseFee > maxFee$.
		\item \textbf{Refund:} $maxFee - (baseFee + priorityFee)$ is refunded to the user after transaction execution. 
	\end{itemize}	
\end{frame}
%%%

%%%
% TODO: remainingGas ist etwas verwirrend (mal in ETH, mal nicht)
\begin{frame}{Understanding the Ethereum Fee Process}
\begin{table}
	\tiny
	{\renewcommand{\arraystretch}{2}%
  \center
  \begin{tabular}[]{m{0.19\textwidth} | m{0.39\textwidth}| m{0.35\textwidth}}
  		\hline \hline
		\textbf{Trigger} & \textbf{Consequence} & \textbf{remainingGas in ETH}\\
		\hline
			Transaction initiation
			& User sets \textbf{gasLimit} and \textbf{gasPrice} and places an amount in GWEI equal to the product of the two in \textbf{transactionEscrow}. \newline \newline \textbf{transactionEscrow = gasLimit $\cdot$ gasPrice}
			& \textbf{remainingGas = gasLimit $\cdot$ gasPrice}\\
		\hline
			For each operation
			& The \textbf{remainingGas} is decreased by operation’s gas consumption (\textbf{opCost}).
			& \textbf{remainingGas = remainingGas - opCost}\\
		\hline
			If \textbf{remainingGas} $\leq$ 0
			& If \textbf{remainingGas} is 0 or insufficient and there are operations remaining, the transaction is reverted (but still included in the Blockchain and \textbf{gasLimit $\cdot$ gasPrice} paid as fee).
			& \textbf{remainingGas} $\leq$ 0\\
		\hline
			If all operations are successful
			& State changes get applied and any unused ETH returned to the sender of the transaction. \newline \newline
			\textbf{Refund = remainingGas $\cdot$ gasPrice} \newline \newline % TODO: remove gasPrice?
			\textbf{Fee = (gasLimit - remainingGas) $\cdot$ gasPrice} % TODO: remove gasPrice?
			& Is multiplied with \textbf{gasPrice} and then refunded to the transaction originator’s address\\% TODO: remove "multiplied with gasPrice and then"?		\hline
		\multicolumn{3}{r}{All values in GWEI = ETH $\cdot$ 10$^{-9}$}\\
  \end{tabular}}
\end{table}
\end{frame}
%%%

%%%
\begin{frame}{A Gas Consumption Example}
	\begin{center}
	 	\begin{tabular}{m{0.2\textwidth} m{0.3\textwidth}}
	 		\includegraphics[width=2cm]{../assets/images/gas-pump.png} &
			\parbox{\textwidth}{gasLimit: 100 \\
    		remainingGas: \only<1>{100}\textcolor{red}{\only<2>{97}\only<3>{92}\only<4->{62}} \\
    		gasPrice: x}
 		\end{tabular}
	\begin{tikzpicture}
		\input{../assets/figures/gasConsumptionExample.tex}
	\end{tikzpicture}
	\end{center}
\end{frame}
%%%

%%%
\begin{frame}{Essential Tools: Ethereum Gas Tracker}
	\begin{figure}
	\centering
	\begin{minipage}{.45\textwidth}
  		\centering
  		\includegraphics[width=0.9\textwidth]{../assets/images/Etherscan.png}
  		\caption*{\footnotesize \href{https://etherscan.io/}{\link Etherscan}}
	\end{minipage}
	\begin{minipage}{.45\textwidth}
  		\centering
  		\includegraphics[width=0.9\textwidth]{../assets/images/ethGasStation.png}
  		\caption*{\footnotesize \href{https://www.Ethgasstation.info}{\link Eth Gas Station}}
	\end{minipage}
	\end{figure}
	\begin{figure}
		\centering
		\begin{minipage}{0.45\textwidth}
			\includegraphics[width=0.9\textwidth]{../assets/images/gasnow.png}
  			\caption*{\footnotesize \href{https://www.gasnow.org}{\link Gas Now}}			
		\end{minipage}
	\end{figure}
\end{frame}
%%%

%%%
\begin{frame}{Advantages of the Gas System}
	\textbf{Fees help to secure the network:}
	\begin{itemize}
		\item Stops execution of…
		\begin{itemize}
			\item Badly written code
			\item Infinite loops
		\end{itemize}
		\item Reduce spam transactions
		\item Establish a market for priority access to network
	\end{itemize}
	
\begin{exercise}{Exercise 3} % TODO: An EIP-1559 anpassen
\begin{itemize}
	\item Use your Metamask account to issue an ETH transaction with a gasPrice of 100 GWEI. How large do you expect the fee to be considering a gasLimit of 21000?
	\item Use your Metamask account to issue an ETH transaction with a gasPrice of 0 GWEI and a gasLimit 0f 21000. What do you expect to happen?
	\item Use your Metamask account to issue an ETH transaction with a gasPrice of 100 GWEI and a gasLimit of 1000000. What do you expect to happen?
	\item Use your Metamask account to issue an ETH transaction with a gasPrice of 100 GWEI and a gasLimit of 1000. What do you expect to happen?
\end{itemize}
\end{exercise}
\end{frame}
%%%

%%%
\begin{frame}{Gasprice Market - Some Interesting Observations}
	% TODO: Add gas price chart
\end{frame}
%%%

\end{document}