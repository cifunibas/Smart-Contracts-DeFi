% Choose one to switch between slides and handout
%\documentclass[]{beamer}
\documentclass[handout]{beamer}

% Video Meta Data
\title{Smart Contracts and Decentralized Finance}
\subtitle{Lending Protocols}
\author{Prof. Dr. Fabian Schär}
\institute{University of Basel}

% Config File
\input{../config/config.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\thispagestyle{empty}
\begin{frame}[noframenumbering]
	\titlepage
\end{frame}

%%%
\begin{frame}{Introduction}
Besides exchanging assets, \textbf{borrowing} and \textbf{lending} are the most fundamental needs in a financial system. \\

\vspace{1em}
Due to openness and pseudonymity, DeFi loans are always \textbf{collateralized loans} (exception: flash loans).\\

\vspace{1em}
There are two main lending protocol archetypes in DeFi: 
\vspace{1em}
\begin{itemize}
  \item \textbf{Collateral Debt Protocols}
  \item \textbf{Collateral Debt Markets}
\end{itemize}
	
\end{frame}
%%%	


%%%
\begin{frame}{Some Terminology around Lending in DeFi}

\vspace{1em}

		
			\uncover<2-> {\textbf{Position}: Entirety of collateral and debt an address has within a protocol}
			
\vspace{1em}

			
			\uncover<3->  {\textbf{Loan-to-Value} (\textit{LTV}): Percentage at which the value of a collateral asset is counted towards the borrowing capacity by a protocol}
			
			\uncover<3->{ 	\begin{equation}
	  LTV \in [0,1] \label{eq:LTV} 
	\end{equation}}



\end{frame}
%%%	


%%%
\begin{frame}{Some Terminology around Lending in DeFi}

\vspace{1em}


	\uncover<4->{ \textbf{Borrowing capacity} (BC): Total amount a position may borrow via the protocol, given the value of the assets provided as collateral (c) and their respective LTVs}
	
	\uncover<4->{\begin{equation}
	  BC = \sum c_i\, LTV_i  \label{eq:BC} 
	\end{equation}}
		
$	\rightarrow$ New debt for a position can only be drawn as long as its outstanding debt (d) across all assets is below borrowing capacity, i.e. 
\begin{equation}
	  BC > \sum d_i\label{eq:BC_restriction} 
	\end{equation}

	\vspace{1em}

\end{frame}
%%%

%%%
\begin{frame}{Some Terminology around Lending in DeFi}

\vspace{1em}

	\uncover<4->{{\normalsize \textbf{Liquidation threshold } (LT)}: Threshold value of debt in percentage of collateral value at which a position starts to become unhealthy and thus is available for liquidation}
	
	\uncover<4-> {\begin{equation}
	  LTV \in [0,1] \; \;\;\;\; while \; LT \geq LTV   \label{eq:LT} 
	\end{equation}}
	


	\uncover<4->{\textbf{Health Factor } (HF): Relative value of collateral, adjusted by LT, to outstanding debt (d) of a position}

\begin{equation}
	  HF = \frac{\sum c_i \, LT_i}{\sum d_i} \label{eq:HF} 
\end{equation}

	\vspace{1em}

 $	\rightarrow$ A position with $HF \geq 1$ it is considered \textit{healthy}
 
 \vspace{1em}

 $	\rightarrow$ Collateral of an \textit{unhealthy} position is available for liquidation to repay (parts of) the position’s debt  


\end{frame}
%%%





%%%
\begin{frame}{Collateral Debt Protocols (CDP)}

\vspace{-1em}

\begin{figure}[t]
	\centering
	\begin{tikzpicture}[scale=1.0, every node/.style={scale=1.0}]
		\input{../assets/figures/CDP}
	\end{tikzpicture}
\end{figure}

\footnotesize
\vspace{-1em}
\begin{columns}[T]
	\begin{column}{0.49\textwidth}
	\uncover<2->{
		\begin{itemize}
			\item	Stays invested in assets provided as collateral.
			\item	Can borrow the CDP issued asset within the borrowing capacity.
			\item	Owes interest for the debt in the CDP asset until repayment.
		\end{itemize}
	}
	\end{column}
	\begin{column}{0.49\textwidth}
	\uncover<3->{
		\begin{itemize}
			\item	Issues a protocol asset and borrowing terms.
			\item	Controls the collateral assets as long as there is outstanding debt to cover.
			\item	Allows liquidation of collateral against protocol asset for unhealthy positions.
		\end{itemize}
	}
	\end{column}
\end{columns}
	
\end{frame}
%%%	


%%%
\begin{frame}{Collateral Debt Markets (CDM)}


\vspace{-1em}

\begin{figure}[t]
	\centering
	\begin{tikzpicture}[scale=1.0, every node/.style={scale=1.0}]
		\input{../assets/figures/CDM}
	\end{tikzpicture}
\end{figure}

\footnotesize
\vspace{-1em}
\begin{columns}[T]
	\begin{column}{0.32\textwidth}
	\uncover<2->{
		\begin{itemize}
			\item	Stays invested in assets provided as collateral (becomes also a lender).
			\item	Can borrow assets provided by other users within the borrowing capacity.
			\item	Owes interest on borrowed assets until repayment.
		\end{itemize}
	}
	\end{column}
	\begin{column}{0.32\textwidth}
	\uncover<3->{
		\begin{itemize}
			\item	Maintains borrowing and lending terms for each asset.
			\item	Holds assets available for borrowing.
			\item	Allows liquidation of collateral against debt for unhealthy positions.
		\end{itemize}
	}
	\end{column}
	\begin{column}{0.32\textwidth}
	\uncover<4->{
		\begin{itemize}
			\item	Provides assets for lending.
			\item	Earns yield on assets depending on their utilization in borrowing.
			\item	Can withdraw assets (subject to liquidity constraints).
		\end{itemize}
	}
	\end{column}
\end{columns}
	
	
\end{frame}
%%%	


%%%
\begin{frame}{Lender's Perspective}
Transfers assets to the protocol that then can be borrowed against interest $\rightarrow$  Only required in CDM protocols.

\vspace{1em}

Commonly receives a liquidity token for the assets made available, that

\vspace{1em}

\begin{itemize}
  \item Represents a transferable claim for the assets provided
  \item Is used by the protocol to account for interest earned by the lender.
  \item Is burnt against the provided assets plus interest, when the assets are withdrawn from the protocol
\end{itemize}


\end{frame}
%%%	


%%%
\begin{frame}{Lender's Perspective}

Interest received depends on the utilization of the respective asset by borrowers and the proportion kept by the protocol.
\vspace{2em}

$\rightarrow $ \textbf{Interest} earned is \textbf{NOT risk free}: While commonly a reserve mechanism is in place to protect lenders in case of malfunctions or tail-events, they may not suffice, leaving lenders with liquidity tokens, that can not or only partially be reimbursed.


\end{frame}
%%%	



%%%
\begin{frame}{Comparison of two Liquidity Token setups}

	\begin{table}
		\begin{tabular}{ll}
			A & B\\
			C & D
		\end{tabular}
		\caption{This is a table}
		\label{tbl:simpletable}
	\end{table}
	
\end{frame}
%%%	


%%%
\begin{frame}{CDM: Utilization Depending Interest }

\begin{figure}[t]
	\centering
	\begin{tikzpicture}[scale=1.0, every node/.style={scale=1.0}]
		\input{../assets/figures/utilization_interest}
	\end{tikzpicture}
\end{figure}

$if \;L_t > 0 : \; U_t = \dfrac{D_t}{L_t}$

\vspace{1em}

$if \;  U_t < U_{opt} : \; R_t = R_0 + \dfrac{U_t} {U_{opt}}  \; S_1$

\vspace{1em}

$if \; U_t \geq U_{opt} : \; R_t = R_0 + S_1 + \dfrac{U_t - U_{opt}}{U_{exc}}\; S_2$
	
\end{frame}
%%%	


%%%
\begin{frame}{Overcollateralization and Liquidation}

\begin{figure}[t]
	\centering
	\begin{tikzpicture}[scale=0.5, every node/.style={scale=0.8}]
		\input{../assets/figures/liquidation_scenario}
	\end{tikzpicture}
	\caption{Liquidation scenario with $LT = 0.75$}
\end{figure}

	
\end{frame}
%%%	


%%%
\begin{frame}{Liquidations: Two approaches }

As smart contracts, protocols cannot become active by themselves. They rely on arbitrageurs to spot and liquidate unhealthy positions via offering them a liquidation incentive. Two  liquidation approaches can be observed here:


	
\end{frame}
%%%	

%%%
\begin{frame}{Liquidations: Two approaches }


\vspace{1em}

\textbf{Discount Sale} (Aave, Compound)

\begin{itemize}
\item Any unhealthy position’s collateral is offered at a discount from the current on-chain oracle price
\item Liquidator repays (part of the) position’s debt in the respective debt asset and in return receives collateral assets at the discounted price for the repaid amount
\item Pro: Atomic transaction, fast
\item Con: Requires high on-chain oracle price accuracy at all times

\end{itemize}

	
\end{frame}
%%%	


%%%
\begin{frame}{Liquidations: Two approaches }

\vspace{1em}

\textbf{Tend \& Dent Auction} (MakerDAO)

\begin{itemize}
\item English auction of an unhealthy position’s collateral can be started by anyone submitting the first bid
\item Ends when either the maximum auction length is reached or the grace period since the last valid bid. Winning bidder can then release the collateral bought


\item In the tend phase, bidders compete by offering to pay larger proportions of the outstanding debt in exchange for the collateral
\item If a bidder offers to pay the debt in full, the auction enters the dent phase, where bidders can compete further by accepting a lower proportion of the collateral in exchange for repayment of all the debt

\item Pro: Independent of on-chain oracles

\item Con: Time-consuming, costly process for bidders (multiple transactions), no lower bound in collateral sale price
\end{itemize}

	
\end{frame}
%%%	


%%%
\begin{frame}{Flash Loans Overview}

Flash loans are a \textbf{concept unique to DeFi}. They are the only loans in the ecosystem that \textbf{do not require collateral}.

\vspace{1em}

In a flash loan, the funds are borrowed, used, and repaid back \textbf{all in one transaction}.

\vspace{1em}

Instead of collateral, lenders rely on \textbf{transaction atomicity}: If principal plus fee is not paid back in the same transaction, all is reverted as if the funds were never granted.

\vspace{1em}

The transaction is still part of the blockchain but is considered failed and does not lead to any state changes except for nonce update and transaction fees. 



	
\end{frame}
%%%	


%%%
\begin{frame}{Flash Loans Overview}
Conditions for a successful flash loan of $x$ with interest $\rho$  and / or a flat fee $\varphi$:

\vspace{1em}
\begin{itemize}
\item If lending protocol is a CDM, it must have x liquid available:  $x \leq LP_{x^{'}}$ (Flash -minting loosens restriction)


\item  $ x(1+\rho) + \varphi$ must be returned to the protocol at the end of the transaction.


\end{itemize}

	
\end{frame}
%%%	


%%%
\begin{frame}{Example of Arbitrage with Flash Loan}

\begin{figure}[t]
	\centering
	\begin{tikzpicture}[scale=1.0, every node/.style={scale=1.0}]
		\input{../assets/figures/flashloan_payoff}
	\end{tikzpicture}
\end{figure}


$\Pi = max (x^{*}-[x \,(1+\rho) + \varphi ],0) - \epsilon$
	
\end{frame}
%%%	


%%%
\begin{frame}{Summarizing Flash Loans}

Flash loans \textbf{effectively remove capital} constraints for any activity that can be performed in one transaction.

\vspace{1em}

\textbf{Common Use Cases}:

\begin{itemize}
\item Collateral swaps (original use case)
\item Arbitrage
\item Portfolio Refactoring
\item Price Manipulation and Wash Trading

\end{itemize}

\vspace{2em}

$\rightarrow$ While it arguably can be missused, the unique DeFi tool of flash loans have the potential to make markets more efficient and fair.


	
\end{frame}
%%%	


%%%
\begin{frame}{Bib-References}
		Read the Bitcoin Whitepaper, \cite{nakamotoBitcoin2008}.
\end{frame}
%%%

%%%
\begin{frame}%[allowframebreaks]

References must include AAVE, Compund and MAKER Docs
Gervais DeFi Liq Paper, Fabian's Flashloan explainer

\frametitle{References and Recommended Reading}
	\bibliographystyle{amsplain}
	\bibliography{../assets/bib/refs}
\end{frame}
%%%



\end{document}