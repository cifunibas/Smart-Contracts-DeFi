% Choose one to switch between slides and handout
%\documentclass[]{beamer}
\documentclass[handout]{beamer}

% Video Meta Data
\title{Smart Contracts and Decentralized Finance}
\subtitle{Lending Protocols}
\author{Prof. Dr. Fabian Schär}
\institute{University of Basel}

% Config File
\input{../config/config.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\thispagestyle{empty}
\begin{frame}[noframenumbering]
	\titlepage
\end{frame}

%%%
\begin{frame}{Introduction}
Besides exchanging assets, \textbf{borrowing} and \textbf{lending} are the most fundamental needs in a financial system. \\

\vspace{1em}
Due to openness and pseudonymity, DeFi loans exist in two formats:
\vspace{0.5em}
\begin{enumerate}
  \item \textbf{Collaterallized loans} of undefined duration.
  \item \textbf{Flash loans} that are borrowed and repaid in one transaction. 
\end{enumerate} 

\vspace{1em}
Currently, we can distinguish two main lending protocol archetypes in DeFi: \textbf{Collateral Debt Protocols} and \textbf{Collateral Debt Markets}.
	
\end{frame}
%%%	


%%%
\begin{frame}{Some Terminology around Lending in DeFi}

\vspace{1em}

\textbf{Position}: Entirety of an address' collateral $c$ and debt $d$ with a protocol.
			
\vspace{1.0em}
			
\uncover<2-> {
\textbf{Loan-to-Value} (\textit{LTV}): Percentage at which the value of a collateral asset counts towards borrowing capacity. $LTV_i \in [0,1]$
}

\vspace{1.0em}

\uncover<3->{ 
\textbf{Borrowing capacity} (BC): Total amount a position may borrow, given the value of its collateral assets and their respective $LTV$.

\begin{equation}
	BC = \sum c_i\, LTV_i 
	\label{eq:BC} 
\end{equation}
}

\uncover<4->{ 
$\rightarrow$ A position can only take up new debt as long as its existing  debt across all assets is below borrowing capacity, i.e., $BC > \sum d_i$
}

\end{frame}
%%%	


%%%
\begin{frame}{Some Terminology around Lending in DeFi}

\vspace{1em}

\textbf{Liquidation Threshold} (LT): Threshold of debt relative to collateral at which a position becomes unhealthy and thus can be liquidated. $LT_i \in [0,1]$ and $LT_i \geq LTV_i$.

	\begin{equation}
	  		LT =  \frac{\sum c_i \, LT_i}{\sum c_i}
	  	\label{eq:LT} 
	\end{equation}
	

\vspace{1.0em}
\uncover<2->{
\textbf{Health Factor} (HF): Relative value of collateral, adjusted by LT, to outstanding debt of a position.

\begin{equation}
	  HF = \frac{\sum c_i \, LT_i}{\sum d_i} \label{eq:HF} 
\end{equation}

\vspace{1.0em}
$\rightarrow$ A position with $HF \geq 1$ it is considered \color{focus} \textit{healthy} \color{black} .

$\rightarrow$ Collateral of \color{focus} \textit{unhealthy}\color{black} positions is available for liquidation.
}

\end{frame}
%%%





%%%
\begin{frame}{Collateral Debt Protocols (CDP)}

\vspace{-1em}

\begin{figure}[t]
	\centering
	\begin{tikzpicture}[scale=1.0, every node/.style={scale=1.0}]
		\input{../assets/figures/CDP}
	\end{tikzpicture}
\end{figure}

\small
\vspace{-1em}
\begin{columns}[T]
	\begin{column}{0.49\textwidth}
	\uncover<2->{
		\begin{itemize}
			\item	Stays invested in assets provided as collateral.
			\item	Can borrow the CDP issued asset within the borrowing capacity.
			\item	Owes interest for the debt in the CDP asset until repayment.
		\end{itemize}
	}
	\end{column}
	\begin{column}{0.49\textwidth}
	\uncover<3->{
		\begin{itemize}
			\item	Issues a protocol asset and sets borrowing terms.
			\item	Controls the collateral assets as long as there is outstanding debt to cover.
			\item	Allows liquidation of collateral against protocol asset for unhealthy positions.
		\end{itemize}
	}
	\end{column}
\end{columns}
	
\end{frame}
%%%	


%%%
\begin{frame}{Collateral Debt Markets (CDM)}


\vspace{-1em}

\begin{figure}[t]
	\centering
	\begin{tikzpicture}[scale=1.0, every node/.style={scale=1.0}]
		\input{../assets/figures/CDM}
	\end{tikzpicture}
\end{figure}

\small
\vspace{-1em}
\begin{columns}[T]
	\begin{column}{0.33\textwidth}
	\uncover<2->{
		\begin{itemize}
			\item	Stays invested in assets provided as collateral (also becomes lender).
			\item	Borrows assets provided by lenders subject to BC.
			\item	Owes interest on borrowed assets until repayment.
		\end{itemize}
	}
	\end{column}
	\begin{column}{0.34\textwidth}
	\uncover<3->{
		\begin{itemize}
			\item	Sets borrowing and lending terms for each asset.
			\item	Holds assets available for borrowing.
			\item	Allows liquidation of collateral against debt for unhealthy positions.
		\end{itemize}
	}
	\end{column}
	\begin{column}{0.32\textwidth}
	\uncover<4->{
		\begin{itemize}
			\item	Provides assets for lending.
			\item	Earns yield on assets depending on their utilization in borrowing.
			\item	Can withdraw assets (subject to liquidity constraints).
		\end{itemize}
	}
	\end{column}
\end{columns}
	
	
\end{frame}
%%%	


%%%
\begin{frame}{Lender's Perspective}

Transfers assets to the protocol (CDM only) that then can be borrowed against interest.

\vspace{1.0em}

Commonly receives a \emph{liquidity token} for the assets provided, that:
\vspace{0.5em}
\begin{itemize}
  \item Represents a \textbf{transferable claim} for the assets,
  \item \textbf{accounts for interest} earned, and
  \item is \textbf{burnt to withdraw} the assets accrued interest.
\end{itemize}

\vspace{1.0em}
$\Rightarrow$ Interest earned is \textbf{not risk free}: Protocol malfunctions or tail events that block necessary liquidations may leave lenders with liquidity tokens, that can not or only partially be reimbursed. These situations may be temporary or permanent.

\end{frame}
%%%	


%%%
\begin{frame}{Comparison of two Liquidity Token setups}

	\begin{table}
		\begin{tabular}{ll}
			A & B\\
			C & D
		\end{tabular}
		\caption{This is a table}
		\label{tbl:simpletable}
	\end{table}
	
\end{frame}
%%%	


%%%
\begin{frame}{CDM: Utilization Depending Interest }

Interest earned is commonly variable and depends on the actual \textit{utilization} of the assets by borrowers.

\begin{figure}[t]
	\centering
	\begin{tikzpicture}[scale=1.0, every node/.style={scale=1.0}]
		\input{../assets/figures/utilization_interest}
	\end{tikzpicture}
\end{figure}

$if \;L_t > 0 : \; U_t = \dfrac{D_t}{L_t}$

\vspace{1em}

$if \;  U_t < U_{opt} : \; R_t = R_0 + \dfrac{U_t} {U_{opt}}  \; S_1$

\vspace{1em}

$if \; U_t \geq U_{opt} : \; R_t = R_0 + S_1 + \dfrac{U_t - U_{opt}}{U_{exc}}\; S_2$
	
\end{frame}
%%%	


%%%
\begin{frame}{Overcollateralization and Liquidation}

\begin{figure}[t]
	\centering
	\begin{tikzpicture}[scale=0.5, every node/.style={scale=0.8}]
		\input{../assets/figures/liquidation_scenario}
	\end{tikzpicture}
	\caption{Liquidation scenario with $LT = 0.75$}
\end{figure}

	
\end{frame}
%%%	


%%%
\begin{frame}{Liquidations: Two approaches (cont.)}

With protocols unable to become active by themselves, they rely on arbitrageurs to spot and liquidate unhealthy positions.

\vspace{1 em}
Two approaches offering liquidation incentives can be observed: 

\vspace{1 em}
\textbf{1. Discount Sale} (e.g. Aave or Compound)
\vspace{0.2em}
\begin{itemize}
\item Any unhealthy position’s collateral is offered at a discount from the current on-chain oracle price.
\item Liquidator repays (part of the) position’s debt in the respective debt asset and in return receives collateral assets at the discounted price for the repaid amount.
\end{itemize}

\vspace{0.5em}
\textbf{Pro:} Atomic transaction, fast.

\textbf{Con:} Requires high accuracy of on-chain oracle prices at all times.





	
\end{frame}
%%%	


%%%
\begin{frame}{Liquidations: Two approaches }


\textbf{2. Tend \& Dent Auction} (e.g. MakerDAO)
\vspace{0.2em}
\begin{itemize}
\item English auction of an unhealthy position’s collateral can be started by anyone submitting the first bid.
\item Ends when either the maximum auction length is reached or the grace period since the last valid bid.
\item In the \emph{tend phase}, bidders compete by offering to pay larger proportions of the outstanding debt in exchange for the collateral.
\item If there is a bid to pay the debt in full, the auction enters the \textit{dent phase}. Now bidders compete further by accepting a lower proportion of the collateral for repayment of the debt in full.
\end{itemize}
\vspace{0.5em}

\textbf{Pro: }Independent of on-chain oracles.

\textbf{Con: }Time-consuming, costly process for bidders (multiple transactions) and no minimum sale price.


	
\end{frame}
%%%	


%%%
\begin{frame}{Flash Loans Overview}

\begin{minipage}{0.3\textwidth}
	\begin{figure}
		\includegraphics[width=0.7\textwidth]{../assets/images/flashloan}	
	\end{figure}
\end{minipage}
\begin{minipage}{0.65\textwidth}
	Flash loans are a \textbf{concept unique to DeFi}. They are the only loans in the ecosystem that \textbf{do not require collateral}.
\end{minipage}

\uncover<2-> {
\vspace{2em}
In a flash loan, the funds are borrowed, used, and repaid back \textbf{all in one transaction}.
}

\vspace{1em}

\uncover<3-> {
Instead of collateral, lenders rely on \textbf{transaction atomicity}: If principal plus fee is not paid back in the same transaction, all is reverted as if the funds were never granted.
}

\end{frame}
%%%	


%%%
\begin{frame}{Flash Loan Conditions}
For a successful flash loan of $x$ with interest $\rho$  and / or a flat fee $\varphi$:

\vspace{1em}
\begin{enumerate}

\item Unless procured from a CDP, where $x$ can be \textit{flash-minted}, the lending market must \textbf{have $x$ liquid available.}\\
$x \leq LP_{x}$

\item The whole principal plus all interest and fees ($ x(1+\rho) + \varphi$) must be \textbf{returned at the end of the transaction.}

\end{enumerate}

\vspace{1em}
$\Rightarrow$ If conditions are not met, the flash loan transaction is still included in the blockchain but is considered failed, i.e., it does not lead to any state changes except for a nonce update and transaction fee $\epsilon$. 


	
\end{frame}
%%%	


%%%
\begin{frame}{Example of Arbitrage with Flash Loan}

With $x$ as the amount borrowed and sold at the high-price exchange and $x^\ast$ the amount bought back at the low-price exchange with the proceeds, the payoff $\Pi$ can be expressed as:

\begin{equation}
	\Pi = max (x^{\ast}-[x \,(1+\rho) + \varphi ],0) - \epsilon
\end{equation}

\vspace{0.5 em}

\uncover<2->{
\begin{minipage}{0.6\textwidth}
	\begin{figure}[t]
		\centering
		\begin{tikzpicture}[scale=0.6, every node/.style={scale=0.6}]
			\input{../assets/figures/flashloan_payoff}
		\end{tikzpicture}
		\caption{Flash Loan Payoff Diagram}
	\end{figure}
\end{minipage}
\begin{minipage}{0.38 \textwidth}
	Is a corresponding flash loan available when a token pair has a significant price difference on-chain, \textbf{anyone can become an arbitrageur }with the loss potential capped at transaction fee $\epsilon$.
\end{minipage}
}
	
\end{frame}
%%%	


%%%
\begin{frame}{Consequence of Flash Loans}

Flash loans \textbf{effectively remove capital} constraints for any activity that can be performed in one transaction.

\vspace{1em}

\textbf{Common Use Cases}:

\begin{itemize}
\item Collateral swaps (original use case)
\item Arbitrage
\item Portfolio Refactoring
\item Price Manipulation and Wash Trading

\end{itemize}

\vspace{2em}

$\Rightarrow$ While it arguably can be missused, the unique DeFi tool of flash loans have the potential to make markets more efficient and fair.


	
\end{frame}
%%%	


%%%
\begin{frame}{Bib-References}
		Read the Bitcoin Whitepaper, \cite{nakamotoBitcoin2008}.
\end{frame}
%%%

%%%
\begin{frame}%[allowframebreaks]

References must include AAVE, Compund and MAKER Docs
Gervais DeFi Liq Paper, Fabian's Flashloan explainer

\frametitle{References and Recommended Reading}
	\bibliographystyle{amsplain}
	\bibliography{../assets/bib/refs}
\end{frame}
%%%



\end{document}