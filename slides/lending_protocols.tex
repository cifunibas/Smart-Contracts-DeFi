% Choose one to switch between slides and handout
%\documentclass[]{beamer}
\documentclass[handout]{beamer}

% Video Meta Data
\title{Smart Contracts and Decentralized Finance}
\subtitle{Lending Protocols}
\author{Prof. Dr. Fabian Schär}
\institute{University of Basel}

% Config File
\input{../config/config.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\thispagestyle{empty}
\begin{frame}[noframenumbering]
	\titlepage
\end{frame}

%%%
\begin{frame}{Protocol Layer}

\begin{figure}[t]
	\centering
	\resizebox{0.9\textwidth}{!}{
	\begin{tikzpicture}[scale=1.0, every node/.style={scale=1.0}]
		\input{../assets/figures/defi_stack_protocol_layer_lending}
	\end{tikzpicture}}
	\caption{DeFi Stack \cite{FS:21}}
\end{figure}
	
\end{frame}
%%%	


%%%
\begin{frame}{Introduction}
\textbf{Borrowing} and \textbf{lending} are basic needs in any financial system. \\

\vspace{1em}

\uncover<2-> {
Loans exist in various forms, but they usually require at least one of the two following properties:
\vspace{0.5em}
\begin{enumerate}
  \item \textbf{Collateral:} Loan is secured with specific assets.
  \item \textbf{Verifiable Identities:} Legal recourse allows 
\end{enumerate} 
}

In DeFi, loans are mostly collateralized.

\uncover<3-> {
\vspace{1em}
There are two main lending protocol archetypes in DeFi: \textbf{Collateralized Debt Positions} (CDP) and \textbf{Collateralized Debt Markets} (CDM).\\ \vspace{1em}

\uncover<4->{
\begin{keytakeaway}{Unsecured Loans}
	Unsecured loans that can be used outside of a single transaction context require reliable identities. 
\end{keytakeaway}
}	
	
\end{frame}
%%%	


%%%
\begin{frame}{Some Terminology Around Lending in DeFi}

\vspace{1em}

\textbf{Position}: Entirety of an address' collateral $c$ and debt $d$ with a given lending protocol.
			
\vspace{1.0em}
			
\uncover<2-> {
\textbf{Loan-to-Value} (\textit{LTV}): Factor at which the value of a collateral asset $i$ counts towards borrowing capacity. $LTV_i \in [0,1]$
}

\vspace{1.0em}

\uncover<3->{ 
\textbf{Borrowing capacity} ($BC$): Sum of $LTV$-adjusted values across all collateral types in a given position. Determines the maximum value that can be borrowed for the respective position.

\begin{equation*}
	BC = \sum c_i\, LTV_i 
	\label{eq:BC} 
\end{equation*}

$\Rightarrow$ A position can only take up new debt as long as its existing  debt across all assets is below borrowing capacity, i.e., $\sum d_i < BC$.
}

\end{frame}
%%%	


%%%
\begin{frame}{Some Terminology Around Lending in DeFi}

\vspace{1em}

\textbf{Liquidation Threshold} (LT): Threshold of debt relative to collateral at which a position becomes unhealthy and thus can be liquidated. $LT_i \in [0,1]$ and $LT_i \geq LTV_i$.

	\begin{equation*}
	  		LT =  \frac{\sum c_i \, LT_i}{\sum c_i}
	  	\label{eq:LT} 
	\end{equation*}
	

\vspace{1.0em}
\uncover<2->{
\textbf{Health Factor} (HF): Relative value of collateral, adjusted by LT, to outstanding debt of a position.

\begin{equation*}
	  HF = \frac{\sum c_i \, LT_i}{\sum d_i} \label{eq:HF} 
\end{equation*}

\vspace{1.0em}
$\Rightarrow$ A position with $HF \geq 1$ it is considered \color{focus} \textit{healthy}\color{black}.

$\Rightarrow$ Collateral of \color{focus} \textit{unhealthy} \color{black} positions can be liquidated.
}

\end{frame}
%%%





%%%
\begin{frame}{Collateralized Debt Position (CDP)}

\vspace{-1em}

\begin{figure}[t]
	\centering
	\begin{tikzpicture}[scale=1.0, every node/.style={scale=1.0}]
		\input{../assets/figures/CDP}
	\end{tikzpicture}
\end{figure}

\small
\vspace{-1em}
\begin{columns}[T]
	\begin{column}{0.49\textwidth}
	\uncover<2->{
		\begin{itemize}
			\item {Stays invested in assets provided as collateral.}
			\item {Can borrow liquid (CDP minted) assets within the borrowing capacity.}
			\item {Owes interest for the debt in the CDP asset until repayment.}
		\end{itemize}
	}
	\end{column}
	\begin{column}{0.49\textwidth}
	\uncover<3->{
		\begin{itemize}
			\item {Controls the collateral assets as long as there is outstanding debt to cover.}
			\item {Mints liquid assets and transfers them to borrower.}
			\item {Allows redemption and liquidation in case of unhealthy positions.}
		\end{itemize}
	}
	\end{column}
\end{columns}
	
\end{frame}
%%%	


%%%
\begin{frame}{Collateralized Debt Markets (CDM)}


\vspace{-1em}

\begin{figure}[t]
	\centering
	\begin{tikzpicture}[scale=1.0, every node/.style={scale=1.0}]
		\input{../assets/figures/CDM}
	\end{tikzpicture}
\end{figure}

\small
\vspace{-1em}
\begin{columns}[T]
	\begin{column}{0.33\textwidth}
	\uncover<2->{
		\begin{itemize}
			\item	Stays invested in assets provided as collateral (also becomes lender).
			\item	Borrows assets provided by lenders subject to BC.
			\item	Owes interest on borrowed assets until repayment.
		\end{itemize}
	}
	\end{column}
	\begin{column}{0.34\textwidth}
	\uncover<3->{
		\begin{itemize}
			\item	Sets borrowing and lending terms for each asset.
			\item	Holds assets available for borrowing.
			\item	Allows liquidation of collateral against debt for unhealthy positions.
		\end{itemize}
	}
	\end{column}
	\begin{column}{0.32\textwidth}
	\uncover<4->{
		\begin{itemize}
			\item	Provides assets for lending.
			\item	Earns yield on assets depending on their utilization in borrowing.
			\item	Can withdraw assets (subject to liquidity constraints).
		\end{itemize}
	}
	\end{column}
\end{columns}
	
	
\end{frame}
%%%	


%%%
\begin{frame}{Lender's Perspective}

Transfers assets to the protocol (CDM only) that then can be borrowed against interest.

\vspace{1.0em}

In CDMs, participants receive \emph{liquidity tokens} for the assets provided. The tokens...
\vspace{0.5em}
\begin{itemize}
  \item ...represent \textbf{transferable claims} to the collateral,
  \item ...\textbf{account for interest} earned
  \item ...are \textbf{burnt to redeem and withdraw} the assets incl. accrued interest.
\end{itemize}

\uncover<2-> {
\vspace{1.0em}
\begin{keytakeaway}{Interest Earned is Not Risk Free}
	Protocol malfunctions or tail events that block necessary liquidations may leave lenders with liquidity tokens, that cannot be (fully) redeemed. These situations may be temporary or permanent.
\end{keytakeaway}
}

\end{frame}
%%%	


%%%
\begin{frame}{Comparison of Two Liquidity Token Setups}

\footnotesize
\begin{table}
  \center
  \begin{tabularx}{\textwidth}{rXX}
    \toprule
    ~	& \textbf{Aave V2} \emph{aToken} & \textbf{Compound} \emph{cToken}	\\
    \midrule
    \textbf{Naming} & a\textit{Reserve} (e.g., aDai) & c\textit{Reserve} (e.g., cDai) \vspace{0.5em}\\
    \textbf{Reserve Translation} & 1:1 & $cToken \cdot XRate_{reserve}$ \vspace{0.5em}\\
    \textbf{Interest Logic} & Base rate + two slopes split by optimal utilization. & Base rate + one slope \textbf{or} two slopes split by optimal utilization. \vspace{0.5em}\\
    \textbf{Security Reserve} & By reserve asset. Held by treasury as aToken. & By reserve asset. Value stored in each contract. \vspace{0.5em}\\
    \textbf{Interest Calculation} & Per second. With every tx affecting debt or liquidity balances. & Per block. With every tx affecting debt or liquidity balances. \vspace{0.5em}\\
    \textbf{Interest Model} & Stable and variable rates. & Variable rates only. \vspace{0.5em}\\
    \textbf{Liquidator} & Can choose between reserve asset and aToken. & Gets cToken.\\
    \bottomrule
  \end{tabularx}
  \caption{Comparison aToken and cToken \cite{AaveV2,Compound}}
\end{table}

\end{frame}
%%%	


%%%
\begin{frame}{CDM: Interest as a Function of Utilization }

Interest owed by borrowers $r_b$ in CDMs is \textbf{commonly variable and depends on \textit{utilization}} $u_t$ of the asset, i.e., how much of the liquidity provided by lender's $L_t$ is currently borrowed $D_t$.

\vspace{1.5em}

\uncover<2-> {
\begin{minipage}{0.6\textwidth}
	\begin{figure}[t]
		\centering
		\begin{tikzpicture}[scale=0.5, every node/.style={scale=0.8}]
			\input{../assets/figures/utilization_interest}
		\end{tikzpicture}
		\caption{Dual Interest Slope}
	\end{figure}
\end{minipage}
\begin{minipage}{0.38\textwidth}
	\vspace{-1em}
	\begin{equation*}
		u_t = \dfrac{D_t}{L_t}
	\end{equation*}
	
	\vspace{0.5 em}
	Two interest slopes set incentives for borrowing when utilization is below optimal $u_{opt}$ and repayment if its above, threatening the lenders' ability to withdraw assets.
	
\end{minipage}	
}

\end{frame}
%%%	


%%%
\begin{frame}{CDM: Borrower's Interest and Lender's Yield }

In a CDM applying two interest slopes for an asset defined by the tuple $(r_{min}, r_{opt}, r_{max}, u_{opt})$, current $r_b$ accrued by borrowers can be expressed as follows:


\begin{equation*}
	r_b = 
		\begin{cases}
		r_{min} + \dfrac{u_t}{u_{opt}}(r_{opt}-r_{min}), & \text{if } u_t \leq u_{opt} \vspace{1em}\\
		r_{opt} + \dfrac{u_t-u_{opt}}{1-u_{opt}}(r_{max}-r_{opt}), & \text{if } u_t > u_{opt}
		\end{cases}
\end{equation*}

\vspace{1em}

\uncover<2-> {
Accounting for a reserve factor $RF \in [0,1]$ deducted as income for the protocol, the $r_b$ collected from borrowers and attributed to the lenders of the asset as yield $r_l$ equals to:

\begin{equation*}
	r_l = u_t r_b (1-RF) 
\end{equation*}
}

\end{frame}
%%%	


%%%
\begin{frame}{A Borrower's Perspective}

With the transfer of collateral assets, \textbf{a credit line is opened }against which assets can be borrowed along the protocol’s terms.

\vspace{0.8 em}
Within CDMs, the collateral commonly becomes part of the assets available for borrowing, i.e., \textbf{a borrower is also a lender.}

\uncover<2-> {
\vspace{0.8 em}
A borrower must continuously \textbf{monitor prices} of collateral and debt assets incl. interest accrued, to avoid their \textbf{position becoming unhealthy}.

\vspace{0.8 em}
If liquidated, a position is \textbf{commonly subject to some penalty} funding the incentivation of liquidators.
}

\uncover<3-> {
\vspace{0.8 em}
\begin{keytakeaway}{Limited Risk for Borrowers}
	Risk of the borrower is effectively limited to the difference between collateral locked and debt drawn, as there is very limited effective recourse to compel repayment of borrowed assets. 
\end{keytakeaway}
}
	
\end{frame}
%%%	


%%%
\begin{frame}{Overcollateralization and Liquidation}

Protocols require a \textbf{minimum overcollateralization} in the pseudoanonymous DeFi environment, i.e., $d \leq c \cdot LT$.
\vspace{1em}

\begin{minipage}{0.6\textwidth}
	\vspace{1.5em}
	\begin{figure}[t]
		\centering
		\begin{tikzpicture}[scale=0.5, every node/.style={scale=0.8}]
			\input{../assets/figures/liquidation_scenario}
		\end{tikzpicture}
		\caption{Scenario with $LT = 0.75$}
	\end{figure}
\end{minipage}
\begin{minipage}{0.38\textwidth}
	
	\uncover<2->{
	If collateral value relative to the debt falls below $LT$, the risk of borrower default is too high, i.e., the position state is \emph{unhealthy}.
	}
	
	\vspace{1em}
	\uncover<3->{
	Collateral can now be liquidated by anyone against repayment of the 		position’s debt.
	}
\end{minipage}
	
\end{frame}
%%%	


%%%
\begin{frame}{Liquidations: Two Approaches (cont.)}

With protocols unable to become active by themselves, they \textbf{rely on arbitrageurs} to spot and liquidate unhealthy positions.

\uncover<2->{
\vspace{1 em}
Two approaches offering liquidation incentives can be observed: 

\vspace{1 em}
\textbf{1. Discount Sale} (e.g. Aave or Compound)
\vspace{0.2em}
\begin{itemize}
\item Any unhealthy position’s collateral is offered at a discount from the current on-chain oracle price.
\item Liquidator repays (part of the) position’s debt in the respective debt asset and in return receives collateral assets at the discounted price for the repaid amount.
\end{itemize}

\vspace{0.5em}
\textbf{Pro:} Atomic transaction, fast.

\textbf{Con:} Requires high accuracy of on-chain oracle prices at all times.
}

\end{frame}
%%%	


%%%
\begin{frame}{Liquidations: Two Approaches }


\textbf{2. Collateral Auction}\\
\vspace{0.2em}
Collateral price discovery via auctions, avoiding fixed liquidator incentives. Example of a format employed by MakerDAO \cite{MakerDAO}:
\begin{itemize}
\item Dutch auction with starting price defined by oracle module. 
\item Collateral price decreases over time. 
\item Liquidators can buy any still available proportion of the collateral at current price.
\item Closes, when all debt is covered. Resets, if price falls below a certain ratio to the starting price or a duration limit is reached.
\end{itemize}
\vspace{0.5em}

\textbf{Pro:} Potentially leaving borrowers with a better collateral price.\\
\vspace{0.5em}
\textbf{Con:} Heavily depending on auction format. Considerations must be given to duration, lower-bound for  prices, oracle role, and resilience during network congestions driving cost of timely transactions.


	
\end{frame}
%%%	


%%%
\begin{frame}{Flash Loans - Intuitively}

\begin{minipage}{0.3\textwidth}
	\begin{figure}
		\includegraphics[width=0.7\textwidth]{../assets/images/flashloan}	
	\end{figure}
\end{minipage}
\begin{minipage}{0.65\textwidth}
Flash Loans \textbf{do not require collateral} and can be granted in the \textbf{absence of reliable identities}. They rely on some unique properties of the EVM.
\end{minipage}

\vspace{2em}

\uncover<2-> {
\begin{minipage}{0.6\textwidth}

	Funds are borrowed, used, and repaid \textbf{within the same transaction}.

	\vspace{1em}
	Lenders rely on \textbf{transaction atomicity}: If principal plus fee cannot be paid back at the end of the transaction, all steps are reverted as if the funds were never granted.
	
\end{minipage}
\begin{minipage}{0.38\textwidth}
	\begin{figure}
		\begin{tikzpicture}[scale=0.8, every node/.style={scale=0.8}]
			\input{../assets/figures/flash_burger}
		\end{tikzpicture}	
	\end{figure}
\end{minipage}
}
\vspace{0.5em}

\uncover<3->{
\link \href{https://eips.ethereum.org/EIPS/eip-3156}{EIP-3156: Flash Loans Specification}
}

\end{frame}
%%%	


%%%
\begin{frame}{Flash Loans - Step by Step}

\small

Let us assume that Alice wants to use a flash loan to borrow $x$ from a liquidity pool with liquidity $LP_x \geq x$. \\

\begin{enumerate}
	\item<2->[1.] Alice deploys a logic contract with a \genkey{onFlashLoan()} function that contains the code for the middle part of the sandwich. %The flash loan contract will later call the \texttt{onFlashLoan()} function of this contract. 
	\item<3->[2a.] Alice calls the \genkey{flashLoan()} function of the flash loan contract. Function arguments include the address of the logic contract, the token type and amount, as well as calldata.
	\item<4->[2b.] Flash loan contract calls \genkey{onFlashLoan()} function in Alice's logic contract, using the provided calldata.
	\item<5->[2c.] \genkey{onFlashLoan()} function in Alice's logic contract is executed.
	\item<6->[2d.] After the execution has \genkey{onFlashLoan()} concluded, the rest of the flash loan contract's \genkey{flashLoan()} function is executed. This includes a \genkey{transferFrom()} to pull $x(1+\rho)+\bar{\rho}$, where $\rho$ is a relative fee and $\bar{\rho}$ is a flat fee.
	\item<7->[2e.] The entire transaction fails if final amount $x^* < x(1+\rho)+\bar{\rho}$ or if the logic contract did not set the necessary allowance with the flash loan contract as a spender address.
\end{enumerate}

\end{frame}
%%%	


%%%
\begin{frame}{Flash Loans - Payoff Function}

\begin{keytakeaway}{Failing Flash Loans}
		Remember: A failed transaction is still included in the blockchain but does not lead to any state changes except for the nonce update and transaction fee $\epsilon$. 
\end{keytakeaway}

\vspace{0.5 em}

\small{
\uncover<2->{
The borrower's payoff function can be expressed as:
}
\begin{equation*}
	\Pi = max (x^{\ast}-[x \,(1+\rho) + \bar{\rho} ],0) - \epsilon
\end{equation*}
}

\uncover<3->{
	\begin{figure}[t]
		\centering
		\begin{tikzpicture}[scale=0.6, every node/.style={scale=0.6}]
			\input{../assets/figures/flashloan_payoff}
		\end{tikzpicture}
		\caption{Flash Loan Payoff Diagram \cite{FS21FlashLoans}}
	\end{figure}
}
	
\end{frame}
%%%	


%%%
\begin{frame}{Flash Loans - Applications}

Flash loans \textbf{effectively remove capital} constraints for any activity that can be performed in one blockchain transaction.

\vspace{1em}

\uncover<2->{
\textbf{Common Use Cases}:

\begin{itemize}
\item Collateral swaps
\item Arbitrage
\item Portfolio restructuring
\item ``Flash Loan Attacks'' (see key takeaway box)

\end{itemize}
}

\vspace{1em}

\uncover<3->{
\begin{keytakeaway}{Flash Loan Attacks}
	The term \textbf{Flash Loan Attack} is a misnomer. While it is true that hackers commonly use flash loans, when they are attacking one or several protocols, the same attacks would also be possible without flash loans. \textbf{Flash loans only provide liquidity}. Consequently it could even be argued, that flash loans have the potential to make markets more efficient and fair.
\end{keytakeaway}
}

\end{frame}
%%%	


%%%
\begin{frame}{Flash Minting}

	In some cases, protocols allow flash minting of their native token. \vspace{0.5em}
	
	\begin{itemize}
		\item This loosens the liquidity constraint $LP_x \geq x$. 
		\item Instead, the amount available to borrowers is given by:\\
			cap $\leq$ \texttt{type(uint256).max - totalSupply()}.
	\end{itemize}
	
	\vspace{1em}
	
	\uncover<2->{
		But: It may also introduce security challenges.
		
		\begin{itemize}
			\item e.g., if third party protocols rely on the \texttt{totalSupply} of a token as part of their security assumptions.
		\end{itemize}
	}
	
\end{frame}

%%%
\begin{frame}%[allowframebreaks]

\frametitle{References and Recommended Reading}

	\bibliographystyle{amsplain}
	\bibliography{../assets/bib/refs}
\end{frame}
%%%



\end{document}