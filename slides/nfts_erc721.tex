% Choose one to switch between slides and handout
%\documentclass[]{beamer}
\documentclass[handout]{beamer}

% Video Meta Data
\title{Smart Contracts and Decentralized Finance}
\subtitle{Non-Fungible Tokens \& ERC721}
\author{Prof. Dr. Fabian Sch√§r}
\institute{University of Basel}

% Config File
\input{../config/config.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\thispagestyle{empty}
\begin{frame}[noframenumbering]
	\titlepage
\end{frame}

%%%
\begin{frame}{(Non-) Fungibility}

So far, we have only considered fungible tokens. However, tokens can also represent ownership of non-fungible assets.\\

\vspace{1em}
\uncover<2->{
\begin{columns}
	\column{0.1\textwidth}
		\includegraphics[scale=0.08]{../assets/images/dollar-bill.png}
	\column{0.8\textwidth}	
		\textbf{Fungibility:} Assets that are \textit{interchangeable}, e.g., a \$1 USD bill or shares in a company.
\end{columns}
}
\vspace{1.5em}
\uncover<3->{
\begin{columns}
	\column{0.1\textwidth}
		\includegraphics[scale=0.08]{../assets/images/mona-lisa.png}
	\column{0.8\textwidth}	
		\textbf{Non-fungibility:} Assets that are \textit{distinct}, e.g., real estate or art.
\end{columns}
}
\end{frame}
%%%

%%%
\begin{frame}{Some Examples}

Some examples of non-fungible token applications (non-exhaustive list):
	\begin{figure}
		\begin{tikzpicture}[scale = 0.8]
			\input{../assets/figures/nft_examples.tex}
		\end{tikzpicture}
	\end{figure}

\uncover<2->{
\begin{keytakeaway}{External promises and counterparty risk}
	Like with ERC20, any external promises are s.t. counterparty issuer risk. The value of the token will depend on the market's expectation regarding the issuer's willingness and ability to fulfill their promise.
\end{keytakeaway}
}
\end{frame}
%%%

%%%
\begin{frame}{Distinction between ERC20 and ERC721}
	While ERC20 tracks the balances that belong to each address, \textbf{ERC721 tracks the owner of a specific tokenID}.
\begin{columns}
\column{0.5\textwidth}
	\vspace{1em}
	\center{ERC20}
		\begin{table}
			\begin{tabular}{l|c}
			Address & Amount \\
			\hline
			0x061F... & 10\\
			0x25ed... & 5
			\end{tabular}
			%\caption*{ERC20}
		\end{table}
		Mapping from owner to balance, with address of the owner being the key of the mapping.
\column{0.5\textwidth}
	\vspace{1em}
	\center{ERC721}
		\begin{table}
			\begin{tabular}{c|l}
			tokenID & Address \\
			\hline
			0 & 0x0901...\\
			1 & 0x7A25...
			\end{tabular}
			%\caption*{\textbf{ERC721}}
		\end{table}
		Mapping from tokenID to owner, with tokenID being the key of the mapping.
\end{columns}
\end{frame}
%%%

%%%
\begin{frame}{ERC721 Token Standard: Functions I}
\begin{itemize}
	\item \textbf{Token standards} specify basic interfaces and allow third party contracts to use tokens in a standardized way.
	\item Token standards set \textbf{minimum requirements}, but do not restrict the design beyond that.
	\item Some functions are very similar to the functions we know from the ERC20 token standard:
\end{itemize}
	\vspace{0.5em}
	\begin{samplecode}{ERC721: Functions known from ERC20}
		\input{../assets/solidity_code/erc721-functions-1.tex}
	\end{samplecode}
\end{frame}
%%%

%%%
\begin{frame}{ERC721 Token Standard: Functions II}
Because of the differences in the way ERC721 Tokens work, there is additionally a \texttt{setApprovalForAll} function which allows an owner to set or unset the approval for \textbf{all} of his tokens in the SC. 
\vspace{1em}
%\begin{itemize}
%	\item \texttt{setApprovalForAll} sets or unsets the approval of a given operator. \texttt{getApproved} returns the approved address for a token ID.
%\end{itemize}
	\begin{samplecode}{ERC721: Functions II}
		\input{../assets/solidity_code/erc721-functions-2.tex}
	\end{samplecode}
\end{frame}
%%%

%%%
\begin{frame}{ERC721 Token Standard: Events}
\vspace{0.5em}
	A \textbf{standardized event set} allows frontends and (off-chain) applications to be developed in a more generic way:
\vspace{1em}
	\begin{samplecode}{Events}
		\input{../assets/solidity_code/erc721-events.tex}
	\end{samplecode}
\end{frame}
%%%

%%%
\begin{frame}{ERC721 Token Standard: safeTransfer}
\begin{itemize}
	\item Problem:
	\item When using \texttt{safeTransferFrom}, the token contract checks if the receiving contract knows how to handle ERC721 tokens. 
	%\item Include this interface when writing a contract that needs to receive ERC721 tokens.
\end{itemize}
\vspace{1em}
	\begin{samplecode}{safeTransfer}
		\input{../assets/solidity_code/erc721-functions-3.tex}
	\end{samplecode}
\end{frame}
%%%


%%%
\begin{frame}{ERC721 Token Standard: Contract Interface}
\vspace{0.5em}
	Any smart contract \textbf{MUST} implement the wallet interface if it will accept safe transfers:
\vspace{1em}
	\begin{samplecode}{Wallet Interface}
		\input{../assets/solidity_code/erc721-wallet-interface.tex}
	\end{samplecode}
\end{frame}
%%%


%%%
%\begin{frame}{ERC721 Token Standard: Functions}
%	A \textbf{standardized function interface} allows smart contracts to interact with any ERC721 token:
%\texttt{\scriptsize
%\vspace{0.5em}
%\begin{itemize}
%	\item<2->	function balanceOf(address $\_$owner) \textcolor{red}{external} view returns (uint256)
%	\item<3->	\textcolor{red}{function ownerOf(uint256 $\_$tokenId) external view returns (address)}
%	\item<4->	\textcolor{red}{function safeTransferFrom(address $\_$from, address $\_$to, uint256 $\_$tokenId, bytes data) external payable}
%	\item<5->	\textcolor{red}{function safeTransferFrom(address $\_$from, address $\_$to, uint256 $\_$tokenId) external payable}
%	\item<6->	function transferFrom(address $\_$from, address $\_$to, uint256 \textcolor{red}{$\_$tokenId}) \textcolor{red}{external payable}
%	\item<7->	function approve(address $\_$approved, uint256 \textcolor{red}{$\_$tokenId}) \textcolor{red}{external payable}
%	\item<8->	\textcolor{red}{function setApprovalForAll(address $\_$operator, bool $\_$approved) external}
%	\item<9->	\textcolor{red}{function getApproved(uint256 $\_$tokenId) external view returns (address)}
%	\item<10->	\textcolor{red}{function isApprovedForAll(address $\_$owner, address $\_$operator) external view returns (bool)}
%\end{itemize}
%}
%\end{frame}
%%%


%%%
%\begin{frame}{Interfaces}
%%Interfaces define the smart contract's functionalities and how to trigger them
%\begin{itemize}
%	\item Interfaces \textbf{define the smart contract's functionalities} and how to trigger them.
%	\item This way, other smart contracts can know how to interact with any smart contract implementing a specific interface.
%	\item A contract interface is a list of function definitions without implementation.
%	\item Each function definition includes the \textbf{function name, parameter types} and \textbf{return value types}.
%	\item An interface leads to two main pieces of information: The \textbf{bytes4 function selector} and the \textbf{interface ID}.
%\end{itemize}
%\end{frame}
%%%

%%%
\begin{frame}{ERC-165 Interface}
Provides a standard method to publish and detect what interfaces a smart contract implements. \link \href{https://eips.ethereum.org/EIPS/eip-165}{EIP-165}
\vspace{1em}
	\begin{samplecode}{Query if a contract implements an interface}
		\input{../assets/solidity_code/erc165.tex}	
	\end{samplecode}
\uncover<2->{
{\footnotesize{
\textbf{Example:} The identifier for this interface is \texttt{0x01ffc9a7}. You can check this by running \texttt{bytes4(keccak256('supportsInterface(bytes4)'));}.}}\\
\vspace{0.5em}
}
\vspace{1em}
\uncover<3->{
\texttt{supportsInterface} returns \texttt{true} if the \texttt{interfaceID} is \texttt{0x01ffc9a7} or for any other \texttt{interfaceID} the contract implements. It returns \texttt{false} if \texttt{interfaceID} is \texttt{0xffffffff} or for any other \texttt{interfaceID} that is not implemented in the contract.
}
\end{frame}
%%%

%%%
\begin{frame}{Enumerable Extension}
	%The enumerable extension allows enumerating the tokens on chain. 
	Used along with \texttt{balanceOf}, \texttt{tokenOfOwnerByIndex} returns the token ID owned by \texttt{owner} at a given index of its token list.\vspace{0.5em}

	%\includegraphics[scale=0.02]{../assets/images/minus_circle.png}
	 %Requires large gas overhead. \vspace{1em}
 
	\begin{samplecode}{Enumerable Extension}
		\input{../assets/solidity_code/erc721-enumerable-extension.tex}
	\end{samplecode}
	\center
	\vspace{-0.5em}
	\link \href{https://eips.ethereum.org/EIPS/eip-721}{EIP-721: Non-Fungible Token Standard}
\end{frame}
%%%

%%%
\begin{frame}{Enumerable Extension ctd.}
The enumerable extension circumvents the problem that the mapping only works from tokenID to address. Otherwise, there would be no way to get all the tokens of a specific address.
\vspace{0.5em}
		\begin{table}
			\begin{tabular}{c|l|c}
			tokenID & Address & IndexByOwner\\
			\hline
			0 & 0x0901... & 0 \\
			1 & 0x7A25... & 0 \\
			2 & 0x0901... & 1
			\end{tabular}
			%\caption*{\textbf{ERC721}}
		\end{table}
\end{frame}
%%%

%%%
\begin{frame}{Metadata Extension ctd.}
	This extension adds name, symbol, and token URI and is almost always included.
\vspace{0.5em}
	\begin{samplecode}{Metadata Extension}
		\input{../assets/solidity_code/erc721-metadata-extension.tex}
	\end{samplecode}
\vspace{0.5em}
\uncover<2->{
	\begin{keytakeaway}{Mutability of the URI}
		The URI may be mutable, and thus, privileged users may change the referenced metadata of an NFT. \href{https://twitter.com/neitherconfirm/status/1369285946198396928}{\link Twitter thread about an illustrative case in practice.}
	\end{keytakeaway}
}
\end{frame}
%%%


%%%
\begin{frame}{Metadata JSON Schema Example}
	\begin{samplecode}{ERC721 Metadata JSON Schema}
		\input{../assets/other_code/erc721-metadata-json-schema.tex}
	\end{samplecode}
\end{frame}
%%%

%%%
\begin{frame}{On-chain vs. Off-chain Data}
	The \texttt{tokenURI} may point to the metadata of an NFT, but the metadata is not necessarily secured by the blockchain. Examples:\\

	\begin{itemize}
		\item<2-> On-chain generated %, e.g., Autoglyphs % On-chain generated via draw function. When users createGlyph, the _mint function is called which checks if PRICE is paid, etc. If all requirements are met, the contract draws the glyph and returns the URI. If the tokenURI is called, the contract simply returns the output of the draw function.
		\item<3-> On-chain verifiable hash %, e.g., Cryptopunks % Off-chain picture (https://www.larvalabs.com/public/images/cryptopunks/punks.png) which hashes to ac39af4793119ee46bbff351d8cb6b5f23da60222126add4268e261199a2921b can be verified in the smart contract. Also, Cryptopunks are now fully on-chain: https://etherscan.io/address/0x16f5a35647d6f03d5d3da7b35409d65ba03af3b2. Saving 24x24 pixel pictures is do-able on-chain.
		\item<4-> Off-chain stored metadata on a decentralized file system %, e.g., Bored Apes Yacht Club % Metadata in JSON format on IPFS (ipfs://QmeSjSinHpPnmXmspMjwiXyN6zS4E9zccariGR3jxcaWtq/1) incl. link to image (ipfs://QmPbxeGcXhYQQNgsC6a36dDyYUcHgMLnGKnF8pVFmGsvqi). baseURI can be updated via setBaseURI, but requires the user to be the smart contract owner (onlyOwner). owner address is zero address.
		\item<5-> Off-chain stored metadata on a centralized file system %, e.g., Cryptokitties % JSON and image centralized on Dapper Labs website, e.g., (https://api.cryptokitties.co/kitties/2252) and (https://img.cn.cryptokitties.co/0x06012c8cf97bead5deae237070f9587f8e7a266d/2252.svg)
	\end{itemize}
\end{frame}
%%%

%%%
\begin{frame}{On-chain generated}
	\begin{itemize}
		\item E.g., Autoglyphs
		\item On-chain generated via draw function. When users createGlyph, the \texttt{\_mint} function is called. If all requirements are met, the contract draws the glyph and returns the URI.
		\item If \texttt{tokenURI} is called, the contract simply returns the output of the draw function.
	\end{itemize}
	\begin{samplecode}{Autoglyphs: Draw \& Token URI Function}
		\input{../assets/solidity_code/draw_autoglyphs.tex}
	\end{samplecode}
	\vspace{-0.5em}
	\begin{center}
		\link \href{https://etherscan.io/address/0xd4e4078ca3495de5b1d4db434bebc5a986197782}{Autoglyphs Contract}
	\end{center}
\end{frame}
%%%

%%%
\begin{frame}{Autoglyphs}
	\begin{itemize}
		\item Calling the \texttt{tokenURI} function with \texttt{\_tokenID = 0}, the following string output (first 64 symbols) is generated: {\scriptsize \texttt{.|.|.O..-.-.-.-.-.|.|.|.O.O.O.O..O.O.O.O.|.|.|.-.-.-.-.-..O.|.|.}}
		\item Each symbol corresponds to a cell in a 64x64 square grid and represents an instruction to make the drawing.
	\end{itemize}
	\begin{columns}
		\column{0.55\textwidth}
		\begin{table}
		\scriptsize
			\begin{tabular}{c|p{4.5cm}} 
			Sign & Instruction \\
			\hline
			\texttt{.} & Draw nothing in the cell\\
			\texttt{O} & Draw a circle bounded by the cell \\
			\texttt{|} & Draw a centered vertical line the length of the cell.\\
			\texttt{-} & Draw a centered horizontal line the length of the cell.\\
			\texttt{\#} & Fill in the cell completely. \\
			{} & ... \\
			\end{tabular}
			%\caption*{\textbf{ERC721}}
		\end{table}
		\column{0.4\textwidth}
			\begin{figure}
				\center
				\vspace{-0.5em}
				\includegraphics[scale=0.2]{../assets/images/glyph1.png}
				\caption*{Source: \link \href{https://larvalabs.com/autoglyphs/glyph?index=1}{Larva Labs}}	
			\end{figure}
	\end{columns}
\end{frame}
%%%

%%%
\begin{frame}{On-chain verifiable hash}
	\begin{itemize}
		\item E.g., Cryptopunks
		\item Off-chain picture \link \href{https://www.larvalabs.com/public/images/cryptopunks/punks.png}{larvalabs.com} which hashes to \texttt{\scriptsize ac39a\dots 921b} can be verified in the smart contract.
		\item Also, Cryptopunks are now fully on-chain: \link \href{https://etherscan.io/address/0x16f5a35647d6f03d5d3da7b35409d65ba03af3b2}{Etherscan}  %Saving 24x24 pixel pictures is do-able on-chain.
	\end{itemize}
	\begin{samplecode}{Cryptopunks Code Snippet}
		\input{../assets/solidity_code/cryptopunks.tex}
	\end{samplecode}
\vspace{-1em}
\begin{center}
	\link \href{https://etherscan.io/address/0xb47e3cd837ddf8e4c57f05d70ab865de6e193bbb}{CryptoPunks Contract}
\end{center}
\end{frame}
%%%s

%%%
\begin{frame}{Off-chain stored metadata on a decentralized file system}
	\begin{itemize}
		\item E.g., Bored Apes Yacht Club
		\item \texttt{tokenURI} points to the metadata of an NFT which is stored in JSON format on IPFS including link to image. See: \link \href{ipfs://QmeSjSinHpPnmXmspMjwiXyN6zS4E9zccariGR3jxcaWtq/1}{IPFS}
		\item \texttt{baseURI} can be updated via \texttt{setBaseURI}, but requires the user to be the smart contract owner, which is set to the zero address.
	\end{itemize} 
	\begin{columns}[T]
		\begin{column}{0.67\textwidth}
		\vspace{-1em}
			\begin{samplecode}{JSON Metadata of Ape with TokenID 0}
				\input{../assets/other_code/bayc_metadata.tex}
			\end{samplecode}		
		\end{column} %\hfill
		\begin{column}{0.35\textwidth}
			\begin{figure}
				\vspace{-1em}
				\centering
				\includegraphics[scale=0.18]{../assets/images/ape_0.png}
				\caption*{Source: \link \href{https://bafybeibnzhc7vp4hnfcocw7s2jej2tj5xqpwseyz3ifylismh47cr45rhm.ipfs.dweb.link/}{IPFS}}	
			\end{figure}
		\end{column}
	\end{columns}
\end{frame}
%%%


%%%
\begin{frame}{Off-chain stored metadata on a centralized file system}
\begin{itemize}
	\item E.g., Cryptokitties
	\item JSON file \link \href{https://api.cryptokitties.co/kitties/2252}{https://api.cryptokitties.co/kitties/2252} and image centralized on Dapper Labs website.
	\item The operator of the website and the servers has full control over the Metadata and can easily mutate/delete it.
\end{itemize}
\vspace{1em}
\begin{figure}
	\centering
	\includegraphics[scale=0.2]{../assets/images/cryptokitty.png}
	\caption*{Source: \link \href{https://img.cn.cryptokitties.co/0x06012c8cf97bead5deae237070f9587f8e7a266d/2252.svg} {\tiny https://img.cn.cryptokitties.co/0x06012c8cf97bead5deae237070f9587f8e7a266d/2252.svg}	}
\end{figure}
\end{frame}
%%%


%%%
%\begin{frame}%[allowframebreaks]
%\frametitle{References and Recommended Reading}
%	\bibliographystyle{amsplain}
%	\bibliography{../assets/bib/refs}
%\end{frame}
%%%

\end{document}