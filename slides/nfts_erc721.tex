% Choose one to switch between slides and handout
%\documentclass[]{beamer}
\documentclass[handout]{beamer}

% Video Meta Data
\title{Smart Contracts and Decentralized Finance}
\subtitle{Non-Fungible Tokens \& ERC721}
\author{Prof. Dr. Fabian Schär}
\institute{University of Basel}

% Config File
\input{../config/config.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\thispagestyle{empty}
\begin{frame}[noframenumbering]
	\titlepage
\end{frame}

%%%
\begin{frame}{(Non-) Fungibility}

So far, we have only considered fungible tokens. However, tokens can also represent ownership of non-fungible assets.\\

\vspace{1em}
\uncover<2->{
\begin{columns}
	\column{0.1\textwidth}
		\includegraphics[scale=0.08]{../assets/images/dollar-bill.png}
	\column{0.8\textwidth}	
		\textbf{Fungibility:} Assets that are \textit{interchangeable}, e.g., a \$1 USD bill or shares in a company.
\end{columns}
}
\vspace{1.5em}
\uncover<3->{
\begin{columns}
	\column{0.1\textwidth}
		\includegraphics[scale=0.08]{../assets/images/mona-lisa.png}
	\column{0.8\textwidth}	
		\textbf{Non-fungibility:} Assets that are \textit{distinct}, e.g., real estate or art.
\end{columns}
}
\end{frame}
%%%

%%%
\begin{frame}{Some Examples}

Some examples of non-fungible token applications (non-exhaustive list):
	\begin{figure}
		\begin{tikzpicture}[scale = 0.8]
			\input{../assets/figures/nft_examples.tex}
		\end{tikzpicture}
	\end{figure}

\uncover<2->{
\begin{keytakeaway}{External promises and counterparty risk}
	Like with ERC20, any external promises are s.t. counterparty issuer risk. The value of the token will depend on the market's expectation regarding the issuer's willingness and ability to fulfill their promise.
\end{keytakeaway}
}
\end{frame}
%%%

%%%
\begin{frame}{Distinction between ERC20 and ERC721}
	While ERC20 tracks the balances that belong to each address, \textbf{ERC721 tracks the owner of a specific tokenID}. \\	\link \href{https://eips.ethereum.org/EIPS/eip-721}{EIP-721: Non-Fungible Token Standard}	
\begin{columns}
\column{0.5\textwidth}
	\vspace{1em}
	\center{ERC20}
		\begin{table}
			\begin{tabular}{l|c}
			Address & Amount \\
			\hline
			0x061F... & 10\\
			0x25ed... & 5
			\end{tabular}
			%\caption*{ERC20}
		\end{table}
		Mapping from owner to balance, with address of the owner being the key of the mapping.
\column{0.5\textwidth}
	\vspace{1em}
	\center{ERC721}
		\begin{table}
			\begin{tabular}{c|l}
			tokenID & Address \\
			\hline
			0 & 0x0901...\\
			1 & 0x7A25...
			\end{tabular}
			%\caption*{\textbf{ERC721}}
		\end{table}
		Mapping from tokenID to owner, with tokenID being the key of the mapping.
\end{columns}
\end{frame}
%%%

%%%
\begin{frame}{ERC721 Token Standard: Functions I}
\begin{itemize}
	\item \textbf{Token standards} specify basic interfaces and allow third party contracts to use tokens in a standardized way.
	\item Token standards set \textbf{minimum requirements}, but do not restrict the design beyond that.
	\item Some functions are very similar to the functions we know from the ERC20 token standard:
\end{itemize}
	\vspace{0.5em}
	\begin{samplecode}{ERC721: Functions known from ERC20}
		\input{../assets/solidity_code/erc721-functions-1.tex}
	\end{samplecode}
\end{frame}
%%%

%%%
\begin{frame}{ERC721 Token Standard: Functions II}
ERC721 tokens have an additional \texttt{setApprovalForAll} function which allows an owner to set or revoke the approval for \textbf{all} of his tokens in the smart contract. 
\vspace{1em}
	\begin{samplecode}{ERC721: Functions II}
		\input{../assets/solidity_code/erc721-functions-2.tex}
	\end{samplecode}
\end{frame}
%%%

%%%
\begin{frame}{ERC721 Token Standard: Events}
\vspace{0.5em}
	A \textbf{standardized event set} allows frontends and (off-chain) applications to be developed in a more generic way:
\vspace{1em}
	\begin{samplecode}{Events}
		\input{../assets/solidity_code/erc721-events.tex}
	\end{samplecode}
\end{frame}
%%%

%%%
\begin{frame}{ERC721 Token Standard: \texttt{safeTransfer}}
\begin{itemize}
	\item Problem: sending ERC721 tokens to a smart contract which does not know how to handle them results in lost assets.
	\item When using \texttt{safeTransferFrom}, the token contract checks if the receiving contract knows how to handle ERC721 tokens. 
	%\item Include this interface when writing a contract that needs to receive ERC721 tokens.
\end{itemize}
\vspace{1em}
	\begin{samplecode}{safeTransfer}
		\input{../assets/solidity_code/erc721-functions-3.tex}
	\end{samplecode}
\end{frame}
%%%


%%%
\begin{frame}{ERC721 Token Standard: Contract Interface}
\vspace{0.5em}
	Any smart contract \textbf{MUST} implement the wallet interface if it will accept safe transfers:
\vspace{1em}
	\begin{samplecode}{Wallet Interface}
		\input{../assets/solidity_code/erc721-wallet-interface.tex}
	\end{samplecode}
\end{frame}
%%%

%%%
%\begin{frame}{Interfaces}
%%Interfaces define the smart contract's functionalities and how to trigger them
%\begin{itemize}
%	\item Interfaces \textbf{define the smart contract's functionalities} and how to trigger them.
%	\item This way, other smart contracts can know how to interact with any smart contract implementing a specific interface.
%	\item A contract interface is a list of function definitions without implementation.
%	\item Each function definition includes the \textbf{function name, parameter types} and \textbf{return value types}.
%	\item An interface leads to two main pieces of information: The \textbf{bytes4 function selector} and the \textbf{interface ID}.
%\end{itemize}
%\end{frame}
%%%

%%%
\begin{frame}{ERC165 Interface}
Provides a standard method to publish and detect what interfaces a smart contract implements. \link \href{https://eips.ethereum.org/EIPS/eip-165}{EIP-165}
\vspace{1em}
	\begin{samplecode}{Query if a contract implements an interface}
		\input{../assets/solidity_code/erc165.tex}	
	\end{samplecode}

\end{frame}
%%%

%%%
\begin{frame}{ERC165 Example}
The identifier for the ERC721 interface is \texttt{0x80ac58cd}.\\
\vspace{0.5em}
\begin{scriptsize}
\texttt{bytes4(keccak256(‘balanceOf(address)’)) == 0x70a08231
bytes4(keccak256(‘ownerOf(uint256)’)) == 0x6352211e
bytes4(keccak256(‘approve(address,uint256)’)) == 0x095ea7b3
bytes4(keccak256(‘getApproved(uint256)’)) == 0x081812fc
bytes4(keccak256(‘setApprovalForAll(address,bool)’)) == 0xa22cb465
bytes4(keccak256(‘isApprovedForAll(address,address)’)) == 0xe985e9c5
bytes4(keccak256(‘transferFrom(address,address,uint256)’)) == 0x23b872dd
bytes4(keccak256(‘safeTransferFrom(address,address,uint256)’)) == 0x42842e0e
bytes4(keccak256(‘safeTransferFrom(address,address,uint256,bytes)’)) == 0xb88d4fde}
\vspace{0.5em} \\
\texttt{= 0x70a08231\textasciicircum 0x6352211e\textasciicircum 0x095ea7b3\textasciicircum 0x081812fc\textasciicircum 0xa22cb465\textasciicircum 0xe985e9c5\textasciicircum 0x23b872dd \textasciicircum 0x42842e0e\textasciicircum 0xb88d4fde == 0x80ac58cd}
\end{scriptsize}
\vspace{0.5em} \\
\uncover<2->{
\texttt{supportsInterface} returns \texttt{true} if the \texttt{interfaceID} is \texttt{0x80ac58cd} or for any other \texttt{interfaceID} the contract implements. It returns \texttt{false} if \texttt{interfaceID} is \texttt{0xffffffff} or for any other \texttt{interfaceID} that is not implemented in the contract.
}
\end{frame}
%%%

%%%
\begin{frame}{Enumerable Extension}
The enumerable extension circumvents the problem that the mapping only works from tokenID to address. Otherwise, there would be no way to get all the tokens of a specific address.
\vspace{0.5em}
		\begin{table}
			\begin{tabular}{c|l|c}
			tokenID & Address & IndexByOwner\\
			\hline
			0 & \color{focus}{0x0901}... & \color{focus}{0} \\
			1 & 0x7A25... & 0 \\
			2 & \color{focus}{0x0901}... & \color{focus}{1}
			\end{tabular}
			%\caption*{\textbf{ERC721}}
		\end{table}
\end{frame}
%%%

%%%
\begin{frame}{Enumerable Extension ctd.}
	%The enumerable extension allows enumerating the tokens on chain. 
	Used along with \texttt{balanceOf}, \texttt{tokenOfOwnerByIndex} returns the token ID owned by \texttt{owner} at a given index of its token list.\vspace{0.5em}
 
	\begin{samplecode}{Enumerable Extension}
		\input{../assets/solidity_code/erc721-enumerable-extension.tex}
	\end{samplecode}

\end{frame}
%%%

%%%
\begin{frame}{Metadata Extension}
	This extension adds the \texttt{name}, \texttt{symbol}, and \texttt{tokenURI} functions and is almost always included.
\vspace{0.5em}
	\begin{samplecode}{Metadata Extension}
		\input{../assets/solidity_code/erc721-metadata-extension.tex}
	\end{samplecode}
\vspace{0.5em}
\uncover<2->{
	\begin{keytakeaway}{Mutability of the URI}
		The URI may be mutable, and thus, privileged users may change the referenced metadata of an NFT. \href{https://twitter.com/neitherconfirm/status/1369285946198396928}{\link Twitter thread about an illustrative case in practice.}
	\end{keytakeaway}
}
\end{frame}
%%%

%%%
\begin{frame}{Metadata JSON Schema Example}
	\begin{samplecode}{ERC721 Metadata JSON Schema}
		\input{../assets/other_code/erc721-metadata-json-schema.tex}
	\end{samplecode}
\end{frame}
%%%

%%%
\begin{frame}{On-chain vs. Off-chain Data}
	The \texttt{tokenURI} may point to the metadata of an NFT, but the metadata is not necessarily secured by the blockchain. Examples:\\

	\begin{itemize}
		\item<2-> On-chain generated
		\item<3-> On-chain verifiable hash
		\item<4-> Off-chain stored metadata on a decentralized file system
		\item<5-> Off-chain stored metadata on a centralized file system
	\end{itemize}
\end{frame}
%%%

%%%
\begin{frame}{On-chain generated}
	\begin{itemize}
		\item E.g., Loot
		\item Something about mint function?
		\item Calling the \texttt{tokenURI} function with a valid tokenID, e.g. 1, the contract returns a the base64 encoded JSON.
		\item In the JSON file we can find the svg, again encoded in base64.
		\item We can decode (https://www.base64decode.org/) the base64 .svg, which allows us to interpret it with an svg viewer (https://www.svgviewer.dev/).
	\end{itemize}
\begin{samplecode}{Loot TokenID 1 JSON}
		\input{../assets/other_code/loot_json.tex}
	\end{samplecode}
	\vspace{-0.5em}
	\begin{center}
		\link \href{}{Loot Contract}
	\end{center}
\end{frame}
%%%

%%%
\begin{frame}{On-chain verifiable hash}
	\begin{itemize}
		\item E.g., CryptoPunks
		\item Off-chain picture \link \href{https://www.larvalabs.com/public/images/cryptopunks/punks.png}{larvalabs.com} which hashes to \texttt{\scriptsize ac39a\dots 921b} can be verified in the smart contract.
		\item Also, CryptoPunks are now fully on-chain: \link \href{https://etherscan.io/address/0x16f5a35647d6f03d5d3da7b35409d65ba03af3b2}{Etherscan}  %Saving 24x24 pixel pictures is do-able on-chain.
	\end{itemize}
	\begin{samplecode}{CryptoPunks Code Snippet}
		\input{../assets/solidity_code/cryptopunks.tex}
	\end{samplecode}
\vspace{-1em}
\begin{center}
	\link \href{https://etherscan.io/address/0xb47e3cd837ddf8e4c57f05d70ab865de6e193bbb}{CryptoPunks Contract}
\end{center}
\end{frame}
%%%s

%%%
\begin{frame}{Off-chain stored metadata on a decentralized file system}
	\begin{itemize}
		\item E.g., Bored Apes Yacht Club
		\item \texttt{tokenURI} points to the metadata of an NFT which is stored in JSON format on IPFS including link to image. See: \link \href{ipfs://QmeSjSinHpPnmXmspMjwiXyN6zS4E9zccariGR3jxcaWtq/1}{IPFS}
		\item \texttt{baseURI} can be updated via \texttt{setBaseURI}, but requires the user to be the smart contract owner, which is set to the zero address.
	\end{itemize} 
	\begin{columns}[T]
		\begin{column}{0.67\textwidth}
		\vspace{-1em}
			\begin{samplecode}{JSON Metadata of Ape with TokenID 0}
				\input{../assets/other_code/bayc_metadata.tex}
			\end{samplecode}		
		\end{column} %\hfill
		\begin{column}{0.35\textwidth}
			\begin{figure}
				\vspace{-1em}
				\centering
				\includegraphics[scale=0.18]{../assets/images/ape_0.png}
				\caption*{Source: \link \href{https://bafybeibnzhc7vp4hnfcocw7s2jej2tj5xqpwseyz3ifylismh47cr45rhm.ipfs.dweb.link/}{IPFS}}	
			\end{figure}
		\end{column}
	\end{columns}
\end{frame}
%%%


%%%
\begin{frame}{Off-chain stored metadata on a centralized file system}
\begin{itemize}
	\item E.g., Cryptokitties
	\item JSON file \link \href{https://api.cryptokitties.co/kitties/2252}{https://api.cryptokitties.co/kitties/2252} and image centralized on Dapper Labs website.
	\item The operator of the website and the servers has full control over the Metadata and can easily mutate/delete it.
\end{itemize}
\vspace{1em}
\begin{figure}
	\centering
	\includegraphics[scale=0.2]{../assets/images/cryptokitty.png}
	\caption*{Source: \link \href{https://img.cn.cryptokitties.co/0x06012c8cf97bead5deae237070f9587f8e7a266d/2252.svg} {\tiny https://img.cn.cryptokitties.co/0x06012c8cf97bead5deae237070f9587f8e7a266d/2252.svg}	}
\end{figure}
\end{frame}
%%%

\end{document}